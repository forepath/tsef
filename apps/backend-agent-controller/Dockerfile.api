# This file is generated by Nx.
# Build the docker image with `npx nx docker:build backend-agent-controller`.
# Tip: Modify "docker:build" options in project.json to change docker build args.
#
# Run the container with `nx docker:run backend-agent-controller -p 3000:3000`.
#
FROM docker.io/debian:trixie

# Environment variables for the backend api
ENV HOST=0.0.0.0
ENV PORT=3100
ENV WEBSOCKET_PORT=8081
ENV NODE_ENV=development

# Environment variables for the database
ENV DB_HOST=postgres
ENV DB_PORT=5432
ENV DB_USERNAME=postgres
ENV DB_PASSWORD=postgres
ENV DB_DATABASE=postgres

# Environment variables for the keycloak server
ENV KEYCLOAK_AUTH_SERVER_URL=http://keycloak:8080
ENV KEYCLOAK_REALM=forepath
ENV KEYCLOAK_CLIENT_ID=agent-controller
ENV KEYCLOAK_CLIENT_SECRET=

# Environment variables for static API key authentication
# If STATIC_API_KEY is set, API key authentication is used (no Keycloak fallback)
# If STATIC_API_KEY is not set, Keycloak authentication is used
ENV STATIC_API_KEY=

# Environment variables for encryption
ENV ENCRYPTION_KEY=

WORKDIR /app
EXPOSE ${PORT}
EXPOSE ${WEBSOCKET_PORT}

# Copy application code
COPY . /app

# Install required dependencies
RUN apt-get update && apt-get install -y curl bash ca-certificates && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Node.js via nvm
ENV NVM_DIR=/root/.nvm
ENV NODE_VERSION=22.12.0

RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash \
  && . $NVM_DIR/nvm.sh \
  && nvm install $NODE_VERSION \
  && nvm alias default $NODE_VERSION \
  && nvm use default \
  && echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc \
  && echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc \
  && echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc

# Install Docker CLI for Docker-in-Docker functionality
RUN apt-get update && \
    apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y docker-ce-cli && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install dependencies
RUN . $NVM_DIR/nvm.sh && npm ci

# Start the application
CMD ["/bin/bash", "-c", ". $NVM_DIR/nvm.sh && node main.js"]
