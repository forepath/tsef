# This file is generated by Nx.
# Build the docker image with `npx nx run backend-agent-manager:api-container-image`.
# Tip: Modify "api-container-image" options in project.json to change docker build args.
#
# Run the container with `nx docker:run backend-agent-manager -p 3000:3000 -p 8080:8080`.
# Exposes API on port 3000 and WebSocket on port 8080.
# Note: Mount Docker socket for Docker-in-Docker: `-v /var/run/docker.sock:/var/run/docker.sock`
# Uses debian:trixie-slim for smaller image size (~80MB reduction vs full trixie).
#
FROM docker.io/debian:trixie-slim

# Environment variables for the backend api
ENV HOST=0.0.0.0
ENV PORT=3000
ENV WEBSOCKET_PORT=8080
ENV NODE_ENV=development

# Environment variables for the cursor-agent
ENV CURSOR_API_KEY=
ENV AGENT_DEFAULT_IMAGE=ghcr.io/forepath/agenstra-manager-worker:latest

# Environment variables for the database
ENV DB_HOST=postgres
ENV DB_PORT=5432
ENV DB_USERNAME=postgres
ENV DB_PASSWORD=postgres
ENV DB_DATABASE=postgres

# Environment variables for the git repository
ENV GIT_REPOSITORY_URL=
ENV GIT_USERNAME=
ENV GIT_TOKEN=
ENV GIT_PASSWORD=
ENV GIT_PRIVATE_KEY=

# Environment variables for the keycloak server
ENV KEYCLOAK_SERVER_URL=http://keycloak:8080
ENV KEYCLOAK_AUTH_SERVER_URL=http://keycloak:8080
ENV KEYCLOAK_REALM=forepath
ENV KEYCLOAK_CLIENT_ID=agent-manager
ENV KEYCLOAK_CLIENT_SECRET=
ENV KEYCLOAK_TOKEN_VALIDATION=online

# Environment variables for the VNC server
ENV VNC_SERVER_PUBLIC_PORTS=49152-57343
ENV SSH_SERVER_PUBLIC_PORTS=57344-65535
ENV VNC_SERVER_DEFAULT_IMAGE=ghcr.io/forepath/agenstra-manager-vnc:latest

# Environment variables for static API key authentication
# If STATIC_API_KEY is set, API key authentication is used (no Keycloak fallback)
# If STATIC_API_KEY is not set, Keycloak authentication is used
ENV STATIC_API_KEY=

# Environment variables for encryption
ENV ENCRYPTION_KEY=

# Environment variables for CORS
# In production: CORS is disabled by default (most secure). Set CORS_ORIGIN to allow specific origins.
# In development: CORS allows all origins by default. Set CORS_ORIGIN to restrict.
# CORS_ORIGIN: Comma-separated list of allowed origins (e.g., "https://agenstra.com,https://app.agenstra.com")
ENV CORS_ORIGIN=

# Environment variables for rate limiting
# RATE_LIMIT_ENABLED: Enable/disable rate limiting (default: true in production, false in development)
# RATE_LIMIT_TTL: Time window in seconds (default: 60)
# RATE_LIMIT_LIMIT: Maximum number of requests per window (default: 100)
ENV RATE_LIMIT_ENABLED=
ENV RATE_LIMIT_TTL=60
ENV RATE_LIMIT_LIMIT=100

# Set working directory
WORKDIR /app

# Expose ports for the backend API and WebSocket
EXPOSE ${PORT}
EXPOSE ${WEBSOCKET_PORT}

# Install all system dependencies in a single layer for better caching
# Note: trixie-slim may not include all packages, so we explicitly install them
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    bash \
    ca-certificates \
    gnupg \
    lsb-release && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y --no-install-recommends docker-ce-cli && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Node.js via nvm
ENV NVM_DIR=/root/.nvm
ENV NODE_VERSION=22.12.0

RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash && \
    . $NVM_DIR/nvm.sh && \
    nvm install $NODE_VERSION && \
    nvm alias default $NODE_VERSION && \
    nvm use default && \
    echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc && \
    echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc && \
    echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc

# Copy package files first for better layer caching
# Dependencies will only be reinstalled if package.json changes
COPY package*.json ./

# Install npm dependencies
RUN . $NVM_DIR/nvm.sh && npm ci && npm cache clean --force

# Copy application code (this layer changes most frequently)
COPY . /app

# Health check using the health endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:${PORT}/api/health || exit 1

# Start the application
CMD ["/bin/bash", "-c", ". $NVM_DIR/nvm.sh && node main.js"]
