# This file is generated by Nx.
# Build the docker image with `npx nx run backend-agent-manager:ssh-container-image`.
# Tip: Modify "ssh-container-image" options in project.json to change docker build args.
#
# This is a SSH container that runs indefinitely. Use `docker exec` to get a bash session.
# The container includes openssh-server for SSH access.
# Exposes SSH server on port 22.
# Uses debian:trixie-slim for smaller image size (~80MB reduction vs full trixie).
#
FROM docker.io/debian:trixie-slim

# Environment variables for SSH configuration
ENV SSH_USER=ssh
ENV SSH_PASSWORD=changeme

WORKDIR /app

# Install required dependencies
RUN apt-get update && \
    apt-get install -y \
    curl \
    bash \
    ca-certificates \
    openssh-server \
    sudo \
    sshpass \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Create startup script
RUN echo '#!/bin/bash' > /tmp/prepare-ssh.sh && \
    echo 'set -e' >> /tmp/prepare-ssh.sh && \
    echo '' >> /tmp/prepare-ssh.sh && \
    echo '# User setup' >> /tmp/prepare-ssh.sh && \
    echo 'if ! id -u "$SSH_USER" >/dev/null 2>&1; then' >> /tmp/prepare-ssh.sh && \
    echo '  useradd -m -d /app -s /bin/bash $SSH_USER' >> /tmp/prepare-ssh.sh && \
    echo 'fi' >> /tmp/prepare-ssh.sh && \
    echo 'if ! groups $SSH_USER | grep -q "\bsudo\b"; then' >> /tmp/prepare-ssh.sh && \
    echo '  adduser $SSH_USER sudo || true' >> /tmp/prepare-ssh.sh && \
    echo 'fi' >> /tmp/prepare-ssh.sh && \
    echo 'echo "$SSH_USER:$SSH_PASSWORD" | chpasswd' >> /tmp/prepare-ssh.sh && \
    echo 'if ! grep -q "^$SSH_USER ALL=(ALL) NOPASSWD: ALL" /etc/sudoers; then' >> /tmp/prepare-ssh.sh && \
    echo '  echo "$SSH_USER ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers' >> /tmp/prepare-ssh.sh && \
    echo 'fi' >> /tmp/prepare-ssh.sh && \
    echo '' >> /tmp/prepare-ssh.sh && \
    echo '# Add forced sudo to openssh config' >> /tmp/prepare-ssh.sh && \
    echo 'if ! grep -q "^Match User $SSH_USER" /etc/ssh/sshd_config; then' >> /tmp/prepare-ssh.sh && \
    echo '  echo "Match User $SSH_USER" >> /etc/ssh/sshd_config' >> /tmp/prepare-ssh.sh && \
    echo '  echo "    ForceCommand sudo -u root /bin/bash -l" >> /etc/ssh/sshd_config' >> /tmp/prepare-ssh.sh && \
    echo 'fi' >> /tmp/prepare-ssh.sh && \
    echo '' >> /tmp/prepare-ssh.sh && \
    echo '# Restart SSH server' >> /tmp/prepare-ssh.sh && \
    echo 'service ssh restart' >> /tmp/prepare-ssh.sh && \
    echo '' >> /tmp/prepare-ssh.sh && \
    echo '# Keep container running' >> /tmp/prepare-ssh.sh && \
    echo 'tail -f /dev/null' >> /tmp/prepare-ssh.sh && \
    chmod +x /tmp/prepare-ssh.sh

# Expose SSH port
EXPOSE 22

# Start SSH server
CMD ["/tmp/prepare-ssh.sh"]
