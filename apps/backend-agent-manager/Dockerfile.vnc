# This file is generated by Nx.
# Build the docker image with `npx nx docker:build backend-agent-manager`.
# Tip: Modify "docker:build" options in project.json to change docker build args.
#
# Run the container with `nx docker:run backend-agent-manager -p 5901:5901`.
# The VNC port is calculated as 5900 + display number (default display :1 = port 5901).
# Connect an external noVNC instance to this VNC port.
# The VNC password can be configured via VNC_PASSWORD environment variable.
#
FROM docker.io/debian:trixie

# Environment variables for VNC configuration
ENV VNC_USER=root
ENV VNC_PASSWORD=changeme
ENV VNC_DISPLAY=:1
ENV VNC_SETUP_DISPLAY=:99
ENV VNC_RESOLUTION=1920x1080
ENV VNC_DEPTH=24

# Environment variables for Chromium browser
ENV CHROMIUM_DISPLAY=:1
ENV CHROMIUM_FLAGS="--no-sandbox --disable-dev-shm-usage"

WORKDIR /app

# Install required dependencies
RUN apt-get update && \
    apt-get install -y \
    curl \
    bash \
    ca-certificates \
    tigervnc-standalone-server \
    tigervnc-common \
    xfce4 \
    xfce4-goodies \
    chromium \
    x11-utils \
    x11-xserver-utils \
    dbus-x11 \
    fluxbox \
    supervisor \
    net-tools \
    openssl \
    novnc \
    websockify \
    nano \
    htop \
    vim \
    git \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Create VNC user directory and xstartup script
RUN mkdir -p /root/.config/tigervnc && \
    echo "#!/bin/bash" > /root/.config/tigervnc/xstartup && \
    echo "unset SESSION_MANAGER" >> /root/.config/tigervnc/xstartup && \
    echo "unset DBUS_SESSION_BUS_ADDRESS" >> /root/.config/tigervnc/xstartup && \
    echo "export XKL_XMODMAP_DISABLE=1" >> /root/.config/tigervnc/xstartup && \
    echo "[ -r \$HOME/.Xresources ] && xrdb \$HOME/.Xresources" >> /root/.config/tigervnc/xstartup && \
    echo "xsetroot -solid grey" >> /root/.config/tigervnc/xstartup && \
    echo "vncconfig -iconic &" >> /root/.config/tigervnc/xstartup && \
    echo "exec startxfce4" >> /root/.config/tigervnc/xstartup && \
    chmod +x /root/.config/tigervnc/xstartup

# Set Chromium as default browser (autostart entry will be created dynamically in startup script)
RUN mkdir -p /root/.config/xfce4/xfconf/xfce-perchannel-xml && \
    echo '<?xml version="1.0" encoding="UTF-8"?>' > /root/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-settings.xml && \
    echo '<channel name="xfce4-settings" version="1.0">' >> /root/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-settings.xml && \
    echo '  <property name="PreferredWebBrowser" type="string" value="chromium"/>' >> /root/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-settings.xml && \
    echo '</channel>' >> /root/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-settings.xml

# Modify chromium start command
RUN sed -i "s/Exec=\/usr\/bin\/chromium %U/Exec=\/usr\/bin\/chromium ${CHROMIUM_FLAGS} --display=${CHROMIUM_DISPLAY} %U/g" /usr/share/applications/chromium.desktop

# Create desktop cleanup script
RUN echo '#!/bin/bash' > /app/cleanup-desktop.sh && \
    echo 'set -e' >> /app/cleanup-desktop.sh && \
    echo '' >> /app/cleanup-desktop.sh && \
    echo 'find /root -type f -exec grep -l WebBrowser {} \\; -delete' >> /app/cleanup-desktop.sh && \
    chmod +x /app/cleanup-desktop.sh

# Create autostart entry for Clean WebBrowser
RUN echo '[Desktop Entry]' > /usr/share/applications/clean-webbrowser.desktop && \
    echo 'Type=Application' >> /usr/share/applications/clean-webbrowser.desktop && \
    echo 'Name=Clean WebBrowser' >> /usr/share/applications/clean-webbrowser.desktop && \
    echo 'Exec=/app/cleanup-desktop.sh' >> /usr/share/applications/clean-webbrowser.desktop && \
    echo 'StartupNotify=true' >> /usr/share/applications/clean-webbrowser.desktop && \
    echo 'NoDisplay=false' >> /usr/share/applications/clean-webbrowser.desktop && \
    echo 'X-GNOME-Autostart-enabled=true' >> /usr/share/applications/clean-webbrowser.desktop && \
    echo 'OnlyShowIn=XFCE;' >> /usr/share/applications/clean-webbrowser.desktop

# Create autostart entries for Chromium and Clean WebBrowser
RUN mkdir -p /root/.config/autostart && \
    ln -s /usr/share/applications/chromium.desktop /root/.config/autostart/chromium.desktop && \
    ln -s /usr/share/applications/clean-webbrowser.desktop /root/.config/autostart/clean-webbrowser.desktop && \
    mkdir -p /root/Desktop && \
    ln -s /usr/share/applications/chromium.desktop /root/Desktop/chromium.desktop

# Generate noVNC ssl certificate
RUN mkdir -p /opt/novnc/ssl && \
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /opt/novnc/ssl/novnc.key \
    -out /opt/novnc/ssl/novnc.crt \
    -subj "/O=NoVNC/CN=localhost" && \
    chmod 600 /opt/novnc/ssl/novnc.key

# Create startup script
RUN echo '#!/bin/bash' > /app/start-vnc.sh && \
    echo 'set -e' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# Create .Xauthority file to avoid warnings' >> /app/start-vnc.sh && \
    echo 'touch /root/.Xauthority' >> /app/start-vnc.sh && \
    echo 'chmod 600 /root/.Xauthority' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# Set VNC password' >> /app/start-vnc.sh && \
    echo 'mkdir -p /root/.config/tigervnc' >> /app/start-vnc.sh && \
    echo 'echo "$VNC_PASSWORD" | vncpasswd -f > /root/.config/tigervnc/passwd' >> /app/start-vnc.sh && \
    echo 'chmod 600 /root/.config/tigervnc/passwd' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# Kill any existing VNC server on the display' >> /app/start-vnc.sh && \
    echo 'vncserver -kill ${VNC_DISPLAY} 2>/dev/null || true' >> /app/start-vnc.sh && \
    echo 'rm -rf /tmp/.X${VNC_DISPLAY#:}-lock /tmp/.X11-unix/X${VNC_DISPLAY#:} 2>/dev/null || true' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# One-time dummy session to initialize Xfce' >> /app/start-vnc.sh && \
    echo 'if [ ! -f /root/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml ]; then' >> /app/start-vnc.sh && \
    echo '  vncserver ${VNC_SETUP_DISPLAY} -geometry ${VNC_RESOLUTION} -depth ${VNC_DEPTH} -localhost no -SecurityTypes VncAuth' >> /app/start-vnc.sh && \
    echo '  for i in $(seq 1 120); do' >> /app/start-vnc.sh && \
    echo '    if [ -f /root/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml ]; then' >> /app/start-vnc.sh && \
    echo '      break' >> /app/start-vnc.sh && \
    echo '    fi' >> /app/start-vnc.sh && \
    echo '    sleep 0.5' >> /app/start-vnc.sh && \
    echo '  done' >> /app/start-vnc.sh && \
    echo '  vncserver -kill ${VNC_SETUP_DISPLAY} || true' >> /app/start-vnc.sh && \
    echo 'fi' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# Start VNC server' >> /app/start-vnc.sh && \
    echo 'vncserver ${VNC_DISPLAY} -geometry ${VNC_RESOLUTION} -depth ${VNC_DEPTH} -localhost no -SecurityTypes VncAuth' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# Websockify server' >> /app/start-vnc.sh && \
    echo 'websockify -D --web /usr/share/novnc/ --cert /opt/novnc/ssl/novnc.crt --key /opt/novnc/ssl/novnc.key 6080 localhost:5901' >> /app/start-vnc.sh && \
    echo '' >> /app/start-vnc.sh && \
    echo '# Keep container running' >> /app/start-vnc.sh && \
    echo 'tail -f /dev/null' >> /app/start-vnc.sh && \
    chmod +x /app/start-vnc.sh

# Expose noVNC port
EXPOSE 6080

# Start VNC server
CMD ["/app/start-vnc.sh"]
