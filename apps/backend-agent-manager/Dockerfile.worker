# This file is generated by Nx.
# Build the docker image with `npx nx run backend-agent-manager:worker-container-image`.
# Tip: Modify "worker-container-image" options in project.json to change docker build args.
#
# This is a worker container that runs indefinitely. Use `docker exec` to get a bash session.
# The container includes Node.js, Nx, and cursor-agent for running agent tasks.
# No ports are exposed as this container is used for background processing.
# Uses debian:trixie-slim for smaller image size (~80MB reduction vs full trixie).
#
FROM docker.io/debian:trixie-slim

# Environment variables for the git repository
ENV GIT_REPOSITORY_URL=
ENV GIT_USERNAME=
ENV GIT_TOKEN=
ENV GIT_PASSWORD=
ENV GIT_PRIVATE_KEY=

# Set working directory
WORKDIR /app

# Install all system dependencies in a single layer for better caching
# Note: trixie-slim may not include all packages, so we explicitly install them
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    bash \
    ca-certificates \
    git \
    openssh-client && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Node.js via nvm
ENV NVM_DIR=/root/.nvm
ENV NODE_VERSION=22.12.0

RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash && \
    . $NVM_DIR/nvm.sh && \
    nvm install $NODE_VERSION && \
    nvm alias default $NODE_VERSION && \
    nvm use default && \
    echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc && \
    echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc && \
    echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc

# Add node binaries to PATH
ENV PATH="/root/.nvm/versions/node/v$NODE_VERSION/bin:$PATH"

# Install nx globally
RUN npm install -g nx && \
    npm cache clean --force

# Install curl with .netrc support from bookworm
# This is done before cursor-agent as it changes less frequently
RUN echo "deb http://deb.debian.org/debian bookworm main" > /etc/apt/sources.list.d/bookworm.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends -t bookworm curl --reinstall && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    rm -f /etc/apt/sources.list.d/bookworm.list

# Install cursor-agent natively
# This is done last in a separate layer as cursor-agent changes most frequently
# This ensures cursor-agent updates don't invalidate cache for nx and other dependencies
RUN curl -fsSL https://cursor.com/install | bash -s -- --prefix /usr/local

# Ensure cursor-agent is in PATH (including $HOME/.local/bin)
ENV PATH="/root/.local/bin:/usr/local/bin:${PATH}"

# Keep container running (use docker exec to get bash session)
CMD [ "tail", "-f", "/dev/null" ]
