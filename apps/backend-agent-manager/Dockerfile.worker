# This file is generated by Nx.
# Build the docker image with `npx nx docker:build backend-agent-manager`.
# Tip: Modify "docker:build" options in project.json to change docker build args.
#
# Run the container with `nx docker:run backend-agent-manager -p 3000:3000`.
#
FROM docker.io/debian:trixie

# Environment variables for the git repository
ENV GIT_REPOSITORY_URL=
ENV GIT_USERNAME=
ENV GIT_TOKEN=
ENV GIT_PASSWORD=
ENV GIT_PRIVATE_KEY=

WORKDIR /app

# Install required dependencies
RUN apt-get update \
  && apt-get install -y curl bash ca-certificates git openssh-client \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Node.js via nvm
ENV NVM_DIR=/root/.nvm
ENV NODE_VERSION=22.12.0

RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash \
  && . $NVM_DIR/nvm.sh \
  && nvm install $NODE_VERSION \
  && nvm alias default $NODE_VERSION \
  && nvm use default \
  && echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc \
  && echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bashrc \
  && echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> ~/.bashrc

# Add node binaries to PATH
ENV PATH="/root/.nvm/versions/node/v$NODE_VERSION/bin:$PATH"

# Install cursor-agent natively
RUN curl -fsSL https://cursor.com/install | bash -s -- --prefix /usr/local

# Ensure cursor-agent is in PATH (including $HOME/.local/bin)
ENV PATH="/root/.local/bin:/usr/local/bin:${PATH}"

# Install nx globally
RUN npm install -g nx

# Install curl with .netrc support
RUN echo "deb http://deb.debian.org/debian bookworm main" > /etc/apt/sources.list.d/bookworm.list \
  && apt-get update \
  && apt-get install -y -t bookworm curl --reinstall \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Keep container running (use docker exec to get bash session)
CMD [ "tail", "-f", "/dev/null" ]
