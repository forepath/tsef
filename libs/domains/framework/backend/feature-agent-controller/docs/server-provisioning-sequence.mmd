sequenceDiagram
    participant Client
    participant Controller
    participant ProvisioningService
    participant ProviderFactory
    participant Provider as Cloud Provider<br/>(Hetzner/DigitalOcean)
    participant CloudAPI as Cloud API<br/>(Hetzner/DigitalOcean)
    participant Server
    participant ClientsService
    participant Database

    Client->>Controller: POST /provisioning/provision
    Controller->>ProvisioningService: provisionServer(dto)

    ProvisioningService->>ProviderFactory: getProvider(type)
    ProviderFactory-->>ProvisioningService: Provider Instance

    ProvisioningService->>ProvisioningService: Generate Auth Config
    ProvisioningService->>ProvisioningService: Generate User Data Script

    ProvisioningService->>Provider: provisionServer(options)
    Provider->>CloudAPI: POST /servers or /droplets (create server)
    CloudAPI-->>Provider: Server Created
    Provider->>Provider: waitForServerReady()

    loop Poll Server Status
        Provider->>CloudAPI: GET /servers/:id or /droplets/:id
        CloudAPI-->>Provider: Server Status
    end

    Note over Server: Server boots and runs cloud-init user data script
    Note over Server: Installs Docker CE
    Note over Server: Starts Agent-Manager container

    Provider->>CloudAPI: GET /servers/:id or /droplets/:id (get IP)
    CloudAPI-->>Provider: Server Info with IP
    Provider-->>ProvisioningService: ProvisionedServer

    ProvisioningService->>ClientsService: create(clientDto)
    ClientsService->>Database: INSERT INTO clients
    Database-->>ClientsService: Client Entity
    ClientsService-->>ProvisioningService: Client Response

    ProvisioningService->>Database: INSERT INTO provisioning_references
    Database-->>ProvisioningService: Provisioning Reference

    ProvisioningService-->>Controller: ProvisionedServerResponseDto
    Controller-->>Client: 201 Created
