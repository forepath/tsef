sequenceDiagram
    participant User as Client
    participant Controller as Agent Controller<br/>(/api/clients/:id/agents/:agentId/deployments)
    participant Proxy as ClientAgentDeploymentsProxyService
    participant ClientRepo as ClientsRepository
    participant ClientService as ClientsService
    participant AgentManager as Agent Manager<br/>(/api/agents/:agentId/deployments)

    rect rgb(230, 240, 255)
        Note over User,AgentManager: Proxy Deployment Configuration Request
        User->>Controller: POST /clients/:id/agents/:agentId/deployments/configuration<br/>{ providerType, repositoryId, providerToken, ... }
        Controller->>Proxy: upsertConfiguration(clientId, agentId, dto)
        Proxy->>ClientRepo: findByIdOrThrow(clientId)
        ClientRepo-->>Proxy: client entity
        Proxy->>ClientService: getAuthHeader(clientId)
        ClientService-->>Proxy: Authorization header
        Proxy->>AgentManager: POST /api/agents/:agentId/deployments/configuration<br/>Authorization: Bearer {token}
        AgentManager-->>Proxy: DeploymentConfigurationResponseDto
        Proxy-->>Controller: configuration
        Controller-->>User: 200 OK { id, agentId, providerType, ... }
    end

    rect rgb(200, 220, 255)
        Note over User,AgentManager: Proxy Trigger Workflow Request
        User->>Controller: POST /clients/:id/agents/:agentId/deployments/workflows/trigger<br/>{ workflowId, ref, inputs? }
        Controller->>Proxy: triggerWorkflow(clientId, agentId, dto)
        Proxy->>ClientRepo: findByIdOrThrow(clientId)
        ClientRepo-->>Proxy: client entity
        Proxy->>ClientService: getAuthHeader(clientId)
        ClientService-->>Proxy: Authorization header
        Proxy->>AgentManager: POST /api/agents/:agentId/deployments/workflows/trigger<br/>Authorization: Bearer {token}
        AgentManager-->>Proxy: DeploymentRunResponseDto
        Proxy-->>Controller: run
        Controller-->>User: 200 OK { id, providerRunId, status, ... }
    end

    rect rgb(240, 250, 255)
        Note over User,AgentManager: Proxy Get Run Status Request
        User->>Controller: GET /clients/:id/agents/:agentId/deployments/runs/:runId
        Controller->>Proxy: getRunStatus(clientId, agentId, runId)
        Proxy->>ClientRepo: findByIdOrThrow(clientId)
        ClientRepo-->>Proxy: client entity
        Proxy->>ClientService: getAuthHeader(clientId)
        ClientService-->>Proxy: Authorization header
        Proxy->>AgentManager: GET /api/agents/:agentId/deployments/runs/:runId<br/>Authorization: Bearer {token}
        AgentManager-->>Proxy: DeploymentRunResponseDto
        Proxy-->>Controller: run
        Controller-->>User: 200 OK { id, status, conclusion, ... }
    end
