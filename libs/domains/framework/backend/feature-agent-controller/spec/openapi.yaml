openapi: 3.1.0
info:
  title: Agent Controller API
  version: 1.0.0
  description: HTTP API for managing clients and proxied agent operations
  contact:
    name: ForePath
    email: hi@forepath.io
    url: https://forepath.io
servers:
  - url: http://localhost:3100/api
    description: Local development
security:
  - bearerAuth: []
paths:
  /clients:
    get:
      summary: List clients
      operationId: listClients
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 0
          description: Maximum number of clients to return (default 10)
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
          description: Number of clients to skip (default 0)
      responses:
        '200':
          description: Array of clients
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientResponseDto'
    post:
      summary: Create client
      operationId: createClient
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientDto'
      responses:
        '201':
          description: Created client with generated API key (if applicable)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateClientResponseDto'
  /clients/{id}:
    get:
      summary: Get client by id
      operationId: getClient
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponseDto'
    post:
      summary: Update client
      operationId: updateClient
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateClientDto'
      responses:
        '200':
          description: Updated client
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientResponseDto'
    delete:
      summary: Delete client
      operationId: deleteClient
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted
  /clients/{id}/agents:
    get:
      summary: List agents for a client
      operationId: listClientAgents
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 0
          description: Maximum number of agents to return (default 10)
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
          description: Number of agents to skip (default 0)
      responses:
        '200':
          description: Array of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AgentResponseDto'
    post:
      summary: Create agent for a client
      operationId: createClientAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAgentDto'
      responses:
        '201':
          description: Created agent with generated password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAgentResponseDto'
  /clients/{id}/agents/{agentId}:
    get:
      summary: Get agent by id for a client
      operationId: getClientAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
      responses:
        '200':
          description: Agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponseDto'
    post:
      summary: Update agent for a client
      operationId: updateClientAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAgentDto'
      responses:
        '200':
          description: Updated agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponseDto'
    delete:
      summary: Delete agent for a client
      operationId: deleteClientAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent to delete
      responses:
        '204':
          description: Deleted
  /clients/{id}/agents/{agentId}/files:
    get:
      summary: List directory contents (proxied)
      operationId: listClientAgentDirectory
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
        - in: query
          name: path
          schema:
            type: string
          description: Directory path relative to /app (defaults to '.')
      responses:
        '200':
          description: Array of file nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FileNodeDto'
        '404':
          description: Client, agent, or directory not found
  /clients/{id}/agents/{agentId}/files/{path}:
    get:
      summary: Read file content (proxied)
      operationId: readClientAgentFile
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File path relative to /app (supports nested paths)
      responses:
        '200':
          description: File content (base64-encoded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileContentDto'
        '400':
          description: Invalid path
        '404':
          description: Client, agent, or file not found
    put:
      summary: Write file content (proxied)
      operationId: writeClientAgentFile
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File path relative to /app (supports nested paths)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WriteFileDto'
      responses:
        '204':
          description: File written successfully
        '400':
          description: Invalid path or content too large
        '404':
          description: Client or agent not found
    delete:
      summary: Delete file or directory (proxied)
      operationId: deleteClientAgentFileOrDirectory
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File or directory path relative to /app (supports nested paths)
      responses:
        '204':
          description: File or directory deleted successfully
        '400':
          description: Invalid path
        '404':
          description: Client, agent, or file/directory not found
    patch:
      summary: Move file or directory (proxied)
      operationId: moveClientAgentFileOrDirectory
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: Source file or directory path relative to /app (supports nested paths)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MoveFileDto'
      responses:
        '204':
          description: File or directory moved successfully
        '400':
          description: Invalid path or destination
        '404':
          description: Client, agent, or source file/directory not found
    post:
      summary: Create file or directory (proxied)
      operationId: createClientAgentFileOrDirectory
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the agent
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File or directory path relative to /app (supports nested paths)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFileDto'
      responses:
        '201':
          description: File or directory created
        '400':
          description: Invalid request
        '404':
          description: Client or agent not found
  /clients/provisioning/providers:
    get:
      summary: List available provisioning providers
      operationId: listProvisioningProviders
      responses:
        '200':
          description: Array of available provisioning providers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProvisioningProviderInfo'
  /clients/provisioning/providers/{providerType}/server-types:
    get:
      summary: Get available server types for a provisioning provider
      operationId: getServerTypes
      parameters:
        - in: path
          name: providerType
          required: true
          schema:
            type: string
          description: The provisioning provider type (e.g., 'hetzner')
      responses:
        '200':
          description: Array of server types with specifications and pricing
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ServerType'
        '400':
          description: Provider type not found or invalid
  /clients/provisioning/provision:
    post:
      summary: Provision a new server and create a client
      operationId: provisionServer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProvisionServerDto'
      responses:
        '201':
          description: Provisioned server with client information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProvisionedServerResponseDto'
        '400':
          description: Invalid request or provisioning failed
  /clients/{id}/provisioning/info:
    get:
      summary: Get server information for a provisioned client
      operationId: getServerInfo
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
      responses:
        '200':
          description: Server information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerInfo'
        '404':
          description: No provisioning reference found for client or client not found
  /clients/{id}/provisioning:
    delete:
      summary: Delete a provisioned server and its associated client
      operationId: deleteProvisionedServer
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: The UUID of the client
      responses:
        '204':
          description: Server and client deleted successfully
        '400':
          description: No provisioning reference found for client
        '404':
          description: Client not found
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    AuthenticationType:
      type: string
      enum:
        - api_key
        - keycloak
    ClientResponseDto:
      type: object
      required: [id, name, endpoint, authenticationType, createdAt, updatedAt]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        endpoint:
          type: string
          format: uri
        authenticationType:
          $ref: '#/components/schemas/AuthenticationType'
        agentWsPort:
          type: integer
          minimum: 1
          maximum: 65535
          description: Optional Socket.IO port for the client's agents gateway
        config:
          $ref: '#/components/schemas/ConfigResponseDto'
          description: Configuration from the agent-manager instance (optional, may be undefined if agent-manager is unreachable)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    CreateClientDto:
      type: object
      required: [name, endpoint, authenticationType]
      properties:
        name:
          type: string
        description:
          type: string
        endpoint:
          type: string
          format: uri
        authenticationType:
          $ref: '#/components/schemas/AuthenticationType'
        apiKey:
          type: string
          description: API key (optional, will be auto-generated if not provided for API_KEY type)
        keycloakClientId:
          type: string
          description: Keycloak client ID (required for KEYCLOAK authentication type)
        keycloakClientSecret:
          type: string
          description: Keycloak client secret (required for KEYCLOAK authentication type)
        keycloakRealm:
          type: string
          description: Keycloak realm (optional, uses environment default if not provided)
        agentWsPort:
          type: integer
          minimum: 1
          maximum: 65535
          description: Optional Socket.IO port for the client's agents gateway (defaults to 8080 if not set)
    UpdateClientDto:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        endpoint:
          type: string
          format: uri
        authenticationType:
          $ref: '#/components/schemas/AuthenticationType'
        apiKey:
          type: string
          description: API key (can be updated but will never be included in responses)
        keycloakClientId:
          type: string
          description: Keycloak client ID
        keycloakClientSecret:
          type: string
          description: Keycloak client secret
        keycloakRealm:
          type: string
          description: Keycloak realm
        agentWsPort:
          type: integer
          minimum: 1
          maximum: 65535
          description: Optional Socket.IO port for the client's agents gateway
    CreateClientResponseDto:
      allOf:
        - $ref: '#/components/schemas/ClientResponseDto'
        - type: object
          properties:
            apiKey:
              type: string
              description: The API key for the client (only for API_KEY authentication type, only returned once during creation)
    CreateAgentDto:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
    UpdateAgentDto:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
    AgentResponseDto:
      type: object
      required: [id, name, createdAt, updatedAt]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    CreateAgentResponseDto:
      allOf:
        - $ref: '#/components/schemas/AgentResponseDto'
        - type: object
          required: [password]
          properties:
            password:
              type: string
    AgentTypeInfo:
      type: object
      required: [type, displayName]
      properties:
        type:
          type: string
          description: The unique type identifier (e.g., 'cursor', 'openai', 'anthropic')
        displayName:
          type: string
          description: Human-readable display name (e.g., 'Cursor', 'OpenAI', 'Anthropic Claude')
    ConfigResponseDto:
      type: object
      required: [agentTypes]
      properties:
        gitRepositoryUrl:
          type: [string, 'null']
          description: Git repository URL used for cloning repositories when creating agents
        agentTypes:
          type: array
          items:
            $ref: '#/components/schemas/AgentTypeInfo'
          description: Array of available agent provider types with display names
    FileContentDto:
      type: object
      required: [content, encoding]
      properties:
        content:
          type: string
          description: File content as base64-encoded string (supports both text and binary files)
        encoding:
          type: string
          enum: [utf-8, base64]
          description: Encoding indicator - 'utf-8' for text files, 'base64' for binary files
    FileNodeDto:
      type: object
      required: [name, type, path]
      properties:
        name:
          type: string
          description: File or directory name
        type:
          type: string
          enum: [file, directory]
          description: Node type
        path:
          type: string
          description: Relative path from /app
        size:
          type: [integer, 'null']
          description: File size in bytes (only for files)
        modifiedAt:
          type: [string, 'null']
          format: date-time
          description: Last modification timestamp
    WriteFileDto:
      type: object
      required: [content]
      properties:
        content:
          type: string
          description: File content as base64-encoded string (supports both text and binary files)
        encoding:
          type: string
          enum: [utf-8, base64]
          description: Optional encoding indicator - 'utf-8' for text files, 'base64' for binary files (defaults to 'utf-8')
    CreateFileDto:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [file, directory]
          description: Type of node to create
        content:
          type: [string, 'null']
          description: Optional content for file creation (base64-encoded)
    MoveFileDto:
      type: object
      required: [destination]
      properties:
        destination:
          type: string
          description: Destination path relative to /app (supports nested paths)
    ProvisioningProviderInfo:
      type: object
      required: [type, displayName]
      properties:
        type:
          type: string
          description: The unique provider type identifier (e.g., 'hetzner')
        displayName:
          type: string
          description: Human-readable display name (e.g., 'Hetzner Cloud')
    ServerType:
      type: object
      required: [id, name, cores, memory, disk]
      properties:
        id:
          type: string
          description: Unique identifier for the server type (e.g., 'cx11', 'cpx11')
        name:
          type: string
          description: Human-readable name (e.g., 'CX11', 'CPX11')
        cores:
          type: integer
          description: Number of CPU cores
        memory:
          type: number
          description: Amount of RAM in GB
        disk:
          type: integer
          description: Disk size in GB
        priceMonthly:
          type: number
          description: Price per month in EUR (or provider's currency)
        priceHourly:
          type: number
          description: Price per hour in EUR (or provider's currency)
        description:
          type: string
          description: Additional description or notes
    ProvisionServerDto:
      type: object
      required: [providerType, serverType, name, authenticationType]
      properties:
        providerType:
          type: string
          description: The provisioning provider type (e.g., 'hetzner')
        serverType:
          type: string
          description: Server type identifier (e.g., 'cx11', 'cpx11')
        name:
          type: string
          description: Server name/label
        description:
          type: string
          description: Optional description
        location:
          type: string
          description: Location/datacenter identifier (e.g., 'nbg1', 'fsn1')
        authenticationType:
          $ref: '#/components/schemas/AuthenticationType'
        apiKey:
          type: string
          description: API key (optional, will be auto-generated if not provided for API_KEY type)
        keycloakClientId:
          type: string
          description: Keycloak client ID (required for KEYCLOAK authentication type)
        keycloakClientSecret:
          type: string
          description: Keycloak client secret (required for KEYCLOAK authentication type)
        keycloakRealm:
          type: string
          description: Keycloak realm (optional, uses environment default if not provided)
        agentWsPort:
          type: integer
          minimum: 1
          maximum: 65535
          description: Optional Socket.IO port for the client's agents gateway (defaults to 8080 if not set)
    ProvisionedServerResponseDto:
      allOf:
        - $ref: '#/components/schemas/ClientResponseDto'
        - type: object
          required: [providerType, serverId, serverName, publicIp, serverStatus]
          properties:
            providerType:
              type: string
              description: Provider type used for provisioning (e.g., 'hetzner')
            serverId:
              type: string
              description: Provider-specific server ID
            serverName:
              type: string
              description: Server name
            publicIp:
              type: string
              description: Public IP address of the server
            privateIp:
              type: string
              description: Private IP address of the server (if applicable)
            serverStatus:
              type: string
              description: Server status (e.g., 'running', 'starting')
    ServerInfo:
      type: object
      required: [serverId, providerType]
      properties:
        serverId:
          type: string
          description: Provider-specific server ID
        serverName:
          type: string
          description: Server name
        publicIp:
          type: string
          description: Public IP address of the server
        privateIp:
          type: string
          description: Private IP address of the server (if applicable)
        serverStatus:
          type: string
          description: Server status (e.g., 'running', 'starting')
        providerType:
          type: string
          description: Provider type used for provisioning (e.g., 'hetzner')
