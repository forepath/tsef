sequenceDiagram
    participant Client as HTTP Client
    participant API as AgentsController<br/>(/api/agents)
    participant Service as AgentsService
    participant Repo as AgentsRepository
    participant DB as Database
    participant Docker as DockerService

    Note over Client,Docker: HTTP API - Agent Management

    rect rgb(230, 240, 255)
        Note over Client,DB: Create Agent
        Client->>API: POST /api/agents<br/>{name, description?}
        API->>Service: create(createAgentDto)
        Service->>Service: generatePassword()
        Service->>Service: hashPassword(password)
        Service->>Service: generateVolumePath()
        Service->>Docker: createContainer(name, env, volumes)
        Note over Docker: Container created with:<br/>- GIT_REPOSITORY_URL<br/>- GIT_USERNAME<br/>- GIT_TOKEN/GIT_PASSWORD<br/>- CURSOR_API_KEY<br/>- Volume mounted at /app
        Docker-->>Service: containerId
        Service->>Docker: createNetrcFile(containerId)
        Note over Docker: Creates /root/.netrc<br/>for git authentication
        Docker-->>Service: .netrc created
        Service->>Docker: sendCommandToContainer(containerId, "git clone {url} /app")
        Note over Docker: Clones repository<br/>into /app (workdir)
        Docker-->>Service: repository cloned
        Service->>Repo: create(entity)
        Repo->>DB: INSERT agent
        DB-->>Repo: agent entity
        Repo-->>Service: agent entity
        Service-->>API: CreateAgentResponseDto<br/>{id, name, description,<br/>password, createdAt, updatedAt}
        API-->>Client: 201 Created<br/>{agent with password}
    end

    rect rgb(240, 255, 240)
        Note over Client,DB: List Agents
        Client->>API: GET /api/agents?limit=10&offset=0
        API->>Service: findAll(limit, offset)
        Service->>Repo: findAll(limit, offset)
        Repo->>DB: SELECT agents LIMIT/OFFSET
        DB-->>Repo: agent entities[]
        Repo-->>Service: agent entities[]
        Service-->>API: AgentResponseDto[]
        API-->>Client: 200 OK<br/>[agents array]
    end

    rect rgb(255, 240, 240)
        Note over Client,DB: Get Agent
        Client->>API: GET /api/agents/{id}
        API->>Service: findOne(id)
        Service->>Repo: findById(id)
        Repo->>DB: SELECT agent WHERE id
        DB-->>Repo: agent entity
        Repo-->>Service: agent entity
        Service-->>API: AgentResponseDto
        API-->>Client: 200 OK<br/>{agent}
    end

    rect rgb(255, 255, 230)
        Note over Client,DB: Update Agent
        Client->>API: POST /api/agents/{id}<br/>{name?, description?}
        API->>Service: update(id, updateAgentDto)
        Service->>Repo: findById(id)
        Repo->>DB: SELECT agent WHERE id
        DB-->>Repo: agent entity
        Repo-->>Service: agent entity
        Service->>Repo: update(id, updates)
        Repo->>DB: UPDATE agent
        DB-->>Repo: updated entity
        Repo-->>Service: updated entity
        Service-->>API: AgentResponseDto
        API-->>Client: 200 OK<br/>{updated agent}
    end

    rect rgb(255, 230, 255)
        Note over Client,DB: Delete Agent
        Client->>API: DELETE /api/agents/{id}
        API->>Service: remove(id)
        Service->>Repo: delete(id)
        Repo->>DB: DELETE agent WHERE id
        DB-->>Repo: success
        Repo-->>Service: success
        Service-->>API: void
        API-->>Client: 204 No Content
    end
