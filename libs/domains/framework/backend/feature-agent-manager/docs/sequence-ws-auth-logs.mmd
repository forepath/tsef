sequenceDiagram
    participant WSClient as WebSocket Client
    participant Gateway as AgentsGateway<br/>(namespace: agents)
    participant Service as AgentsService
    participant Repo as AgentsRepository
    participant DB as Database
    participant Docker as DockerService

    Note over WSClient,Docker: WebSocket - Connection, Login & Log Streaming

    rect rgb(200, 220, 255)
        Note over WSClient,Docker: Connection
        WSClient->>Gateway: WebSocket Connect<br/>(namespace: /agents)
        Gateway->>Gateway: handleConnection(socket)<br/>Log: "Client connected"
    end

    rect rgb(240, 250, 255)
        Note over WSClient,Docker: Authentication Flow
        WSClient->>Gateway: login<br/>{agentId, password}
        Gateway->>Gateway: findAgentIdByIdentifier(agentId)
        Gateway->>Repo: findById(agentId)
        Repo->>DB: SELECT agent WHERE id
        alt Agent found by ID
            DB-->>Repo: agent entity
            Repo-->>Gateway: agent.id (UUID)
        else Agent not found by ID
            Gateway->>Repo: findByName(agentId)
            Repo->>DB: SELECT agent WHERE name
            alt Agent found by name
                DB-->>Repo: agent entity
                Repo-->>Gateway: agent.id (UUID)
            else Agent not found
                Repo-->>Gateway: null
                Gateway-->>WSClient: loginError<br/>{message: "Invalid credentials"}
            end
        end

        alt Agent UUID found
            Gateway->>Service: verifyCredentials(uuid, password)
            Service->>Repo: findById(uuid)
            Repo->>DB: SELECT agent WHERE id
            DB-->>Repo: agent entity
            Repo-->>Service: agent entity
            Service->>Service: verifyPassword(password, hash)
            alt Password valid
                Service-->>Gateway: isValid: true
                Gateway->>Gateway: authenticatedClients.set(socket.id, uuid)
                Gateway->>Service: findOne(uuid)
                Service->>Repo: findById(uuid)
                Repo->>DB: SELECT agent WHERE id
                DB-->>Repo: agent entity
                Repo-->>Service: agent entity
                Service-->>Gateway: agent details
                Gateway-->>WSClient: loginSuccess<br/>{message: "Welcome, {name}!"}
            else Password invalid
                Service-->>Gateway: isValid: false
                Gateway-->>WSClient: loginError<br/>{message: "Invalid credentials"}
            end
        end
    end

    rect rgb(230, 240, 250)
        Note over WSClient,Docker: Container Log Streaming
        Gateway->>Repo: findById(uuid)
        Repo->>DB: SELECT agent WHERE id
        DB-->>Repo: agent entity with containerId
        Repo-->>Gateway: agent entity

        alt Container exists
            Gateway->>Gateway: logStreamCancel.set(socket.id, cancel)<br/>logStreamPromises.set(socket.id, promise)
            Gateway->>Docker: getContainerLogs(containerId)
            alt Log streaming starts successfully
                loop Log streaming (until cancelled or error)
                    Docker-->>Gateway: log line
                    Gateway-->>WSClient: containerLog<br/>{text: logLine}
                end
                alt Stream completed normally
                    Note over Gateway: Stream ended (container stopped)
                else Stream error during execution
                    Docker-->>Gateway: Error thrown
                    Gateway->>Gateway: logger.error()<br/>Cleanup cancel function
                    Gateway-->>WSClient: logStreamError<br/>{message: "Log streaming failed", error: "..."}
                end
            else Failed to start streaming
                Docker-->>Gateway: Error thrown
                Gateway->>Gateway: logger.error()
                Gateway-->>WSClient: logStreamError<br/>{message: "Failed to start log streaming", error: "..."}
            end
        end
    end

    rect rgb(255, 220, 220)
        Note over WSClient,Docker: Disconnection
        WSClient->>Gateway: WebSocket Disconnect
        Gateway->>Gateway: handleDisconnect(socket)<br/>Log: "Client disconnected"
        Gateway->>Gateway: authenticatedClients.delete(socket.id)
        Gateway->>Gateway: cancel = logStreamCancel.get(socket.id)
        alt Cancel function exists
            Gateway->>Gateway: cancel()
            Gateway->>Gateway: logStreamCancel.delete(socket.id)
        end
        Gateway->>Gateway: logStreamPromises.delete(socket.id)
    end
