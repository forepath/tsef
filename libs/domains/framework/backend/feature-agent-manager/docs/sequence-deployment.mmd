sequenceDiagram
    participant User as Client
    participant HTTP as AgentsDeploymentsController<br/>(/api/agents/:agentId/deployments)
    participant Service as DeploymentsService
    participant Repo as DeploymentConfigurationsRepository
    participant RunRepo as DeploymentRunsRepository
    participant PPF as PipelineProviderFactory
    participant Provider as GitHubProvider
    participant GitHub as GitHub REST API
    participant DB as Database

    rect rgb(230, 240, 255)
        Note over User,GitHub: Step 1 - Configure Deployment
        User->>HTTP: POST /configuration<br/>{ providerType, repositoryId, providerToken, ... }
        HTTP->>Service: upsertConfiguration(agentId, dto)
        Service->>Repo: upsertByAgentId(agentId, config)
        Repo->>DB: INSERT/UPDATE deployment_configurations
        DB-->>Repo: configuration entity
        Repo-->>Service: configuration entity
        Service-->>HTTP: DeploymentConfigurationResponseDto
        HTTP-->>User: 200 OK { id, agentId, providerType, ... }
    end

    rect rgb(200, 220, 255)
        Note over User,GitHub: Step 2 - List Repositories
        User->>HTTP: GET /repositories
        HTTP->>Service: listRepositories(agentId)
        Service->>Repo: findByAgentIdOrThrow(agentId)
        Repo->>DB: SELECT deployment_configurations WHERE agent_id
        DB-->>Repo: configuration entity
        Repo-->>Service: configuration entity
        Service->>PPF: getProvider(config.providerType)
        PPF-->>Service: GitHubProvider
        Service->>Provider: listRepositories(credentials)
        Provider->>GitHub: GET /user/repos
        GitHub-->>Provider: repositories array
        Provider-->>Service: Repository[]
        Service-->>HTTP: RepositoryResponseDto[]
        HTTP-->>User: 200 OK [{ id, name, fullName, ... }]
    end

    rect rgb(240, 250, 255)
        Note over User,GitHub: Step 3 - List Workflows
        User->>HTTP: GET /repositories/:repositoryId/workflows
        HTTP->>Service: listWorkflows(agentId, repositoryId, branch?)
        Service->>Repo: findByAgentIdOrThrow(agentId)
        Repo->>DB: SELECT deployment_configurations WHERE agent_id
        DB-->>Repo: configuration entity
        Repo-->>Service: configuration entity
        Service->>PPF: getProvider(config.providerType)
        PPF-->>Service: GitHubProvider
        Service->>Provider: listWorkflows(credentials, repositoryId, branch?)
        Provider->>GitHub: GET /repos/:owner/:repo/actions/workflows
        GitHub-->>Provider: workflows array
        Provider-->>Service: Workflow[]
        Service-->>HTTP: WorkflowResponseDto[]
        HTTP-->>User: 200 OK [{ id, name, path, state, canTrigger }]
    end

    rect rgb(250, 255, 240)
        Note over User,GitHub: Step 4 - Trigger Workflow
        User->>HTTP: POST /workflows/trigger<br/>{ workflowId, ref, inputs? }
        HTTP->>Service: triggerWorkflow(agentId, dto)
        Service->>Repo: findByAgentIdOrThrow(agentId)
        Repo->>DB: SELECT deployment_configurations WHERE agent_id
        DB-->>Repo: configuration entity
        Repo-->>Service: configuration entity
        Service->>PPF: getProvider(config.providerType)
        PPF-->>Service: GitHubProvider
        Service->>Provider: triggerWorkflow(credentials, repositoryId, workflowId, ref, inputs?)
        Provider->>GitHub: POST /repos/:owner/:repo/actions/workflows/:id/dispatches<br/>{ ref, inputs }
        GitHub-->>Provider: 204 No Content
        Note over Provider: Wait 1s, then fetch latest run
        Provider->>GitHub: GET /repos/:owner/:repo/actions/workflows/:id/runs?per_page=1
        GitHub-->>Provider: workflow runs array
        Provider->>GitHub: GET /repos/:owner/:repo/actions/workflows/:id
        GitHub-->>Provider: workflow { name }
        Provider-->>Service: PipelineRun
        Service->>RunRepo: upsertByProviderRunId(configId, runId, runData)
        RunRepo->>DB: INSERT/UPDATE deployment_runs
        DB-->>RunRepo: run entity
        RunRepo-->>Service: run entity
        Service-->>HTTP: DeploymentRunResponseDto
        HTTP-->>User: 200 OK { id, providerRunId, status, ... }
    end

    rect rgb(255, 240, 240)
        Note over User,GitHub: Step 5 - Get Run Status
        User->>HTTP: GET /runs/:runId
        HTTP->>Service: getRunStatus(agentId, runId)
        Service->>Repo: findByAgentIdOrThrow(agentId)
        Repo->>DB: SELECT deployment_configurations WHERE agent_id
        DB-->>Repo: configuration entity
        Repo-->>Service: configuration entity
        Service->>PPF: getProvider(config.providerType)
        PPF-->>Service: GitHubProvider
        Service->>Provider: getRunStatus(credentials, repositoryId, runId)
        Provider->>GitHub: GET /repos/:owner/:repo/actions/runs/:runId
        GitHub-->>Provider: run data
        Provider->>GitHub: GET /repos/:owner/:repo/actions/workflows/:workflowId
        GitHub-->>Provider: workflow { name }
        Provider-->>Service: PipelineRun
        Service->>RunRepo: upsertByProviderRunId(configId, runId, runData)
        RunRepo->>DB: UPDATE deployment_runs
        DB-->>RunRepo: run entity
        RunRepo-->>Service: run entity
        Service-->>HTTP: DeploymentRunResponseDto
        HTTP-->>User: 200 OK { id, status, conclusion, ... }
    end

    rect rgb(240, 255, 250)
        Note over User,GitHub: Step 6 - Get Run Logs
        User->>HTTP: GET /runs/:runId/logs
        HTTP->>Service: getRunLogs(agentId, runId)
        Service->>Repo: findByAgentIdOrThrow(agentId)
        Repo->>DB: SELECT deployment_configurations WHERE agent_id
        DB-->>Repo: configuration entity
        Repo-->>Service: configuration entity
        Service->>PPF: getProvider(config.providerType)
        PPF-->>Service: GitHubProvider
        Service->>Provider: getRunLogs(credentials, repositoryId, runId)
        Provider->>GitHub: GET /repos/:owner/:repo/actions/runs/:runId/jobs
        GitHub-->>Provider: jobs array
        loop For each job
            Provider->>Provider: getJobLogs(credentials, repositoryId, runId, jobId)
            Provider->>GitHub: GET /repos/:owner/:repo/actions/jobs/:jobId/logs
            GitHub-->>Provider: logs (redirect or text)
            Provider->>Provider: Follow redirect if needed
            GitHub-->>Provider: logs text
        end
        Provider-->>Service: Combined logs string
        Service-->>HTTP: { logs: string }
        HTTP-->>User: 200 OK { logs: "..." }
    end
