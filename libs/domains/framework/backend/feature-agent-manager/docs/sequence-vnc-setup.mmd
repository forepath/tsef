sequenceDiagram
    participant User as Client
    participant HTTP as AgentsController<br/>(/api/agents)
    participant Service as AgentsService
    participant Docker as DockerService
    participant Repo as AgentsRepository
    participant DB as Database
    participant AgentContainer as Agent Container
    participant VNCContainer as VNC Container
    participant Network as Docker Network

    Note over User,Network: VNC Container Creation Sequence

    rect rgb(230, 240, 255)
        Note over User,Network: Step 1 - Create Agent Container
        User->>HTTP: POST /api/agents { name, description? }
        HTTP->>Service: create(createAgentDto)
        Service->>Service: generatePassword()
        Service->>Service: hashPassword(password)
        Service->>Service: generateVolumePath()
        Service->>Docker: createContainer(agent config)
        Docker->>AgentContainer: Create & Start Container
        AgentContainer-->>Docker: Container Created
        Docker-->>Service: containerId
    end

    rect rgb(240, 255, 240)
        Note over User,Network: Step 2 - Create VNC Container
        Service->>Service: generateRandomPublicPortFromRange()
        Service->>Service: generateRandomPassword()
        Service->>Docker: createContainer(vnc config)
        Note over Docker: VNC Container Config:<br/>- Image: VNC_SERVER_DOCKER_IMAGE<br/>- Name: {name}-virtual-workspace<br/>- Env: VNC_PASSWORD, AGENT_NAME, etc.<br/>- Port: random host port â†’ 6080<br/>- Volume: shared workspace
        Docker->>VNCContainer: Create & Start Container
        VNCContainer->>VNCContainer: Initialize XFCE4
        VNCContainer->>VNCContainer: Start TigerVNC Server
        VNCContainer->>VNCContainer: Start websockify
        VNCContainer->>VNCContainer: Auto-start Chromium
        VNCContainer-->>Docker: Container Created & Running
        Docker-->>Service: vncContainerId, vncHostPort
    end

    rect rgb(255, 240, 240)
        Note over User,Network: Step 3 - Create Docker Network
        Service->>Docker: createNetwork({ name, containerIds })
        Note over Docker: Network Config:<br/>- Name: {vncContainerId}-network<br/>- Driver: bridge<br/>- Containers: [vncContainerId, containerId]
        Docker->>Network: Create Network
        Network->>Network: Connect VNC Container
        Network->>Network: Connect Agent Container
        Network-->>Docker: Network Created
        Docker-->>Service: networkId
    end

    rect rgb(250, 250, 255)
        Note over User,Network: Step 4 - Store Agent with VNC Info
        Service->>Service: createAgentEntity()
        Note over Service: Agent Entity:<br/>- containerId<br/>- vncContainerId<br/>- vncHostPort<br/>- vncNetworkId<br/>- vncPassword (encrypted)
        Service->>Repo: create(agent entity)
        Repo->>DB: INSERT agent
        DB-->>Repo: agent entity
        Repo-->>Service: agent entity
        Service-->>HTTP: CreateAgentResponseDto
        HTTP-->>User: 201 Created { id, vncHostPort, ... }
    end

    rect rgb(255, 255, 240)
        Note over User,Network: Step 5 - Access VNC Session
        User->>User: Navigate to noVNC
        Note over User: https://{host}:{vncHostPort}/vnc.html
        User->>VNCContainer: HTTPS Request (noVNC)
        VNCContainer->>VNCContainer: websockify bridges to TigerVNC
        VNCContainer->>User: VNC Authentication Prompt
        User->>VNCContainer: Enter VNC Password
        VNCContainer->>VNCContainer: Verify Password
        VNCContainer-->>User: VNC Session Established
        Note over User,VNCContainer: User can now interact with<br/>XFCE4 desktop and Chromium browser
    end
