sequenceDiagram
    participant Client1 as WebSocket Client 1<br/>(Socket ID: socket-1)
    participant Client2 as WebSocket Client 2<br/>(Socket ID: socket-2)
    participant Gateway as AgentsGateway<br/>(namespace: agents)
    participant Service as AgentsService
    participant Repo as AgentsRepository
    participant DB as Database

    Note over Client1,DB: WebSocket - File Update Notification Flow

    rect rgb(200, 220, 255)
        Note over Client1,DB: Prerequisites - Both clients authenticated to same agent
        Note over Client1: Client 1 and Client 2 are both<br/>authenticated to the same agent
    end

    rect rgb(250, 255, 240)
        Note over Client1,DB: File Update Flow
        Client1->>Gateway: fileUpdate<br/>{filePath: "/path/to/file.ts"}
        Gateway->>Gateway: uuid = authenticatedClients.get(socket-1)
        alt Not authenticated
            Gateway-->>Client1: error<br/>{success: false, error: {message, code: "UNAUTHORIZED"}, timestamp}
        else Authenticated
            Gateway->>Gateway: Validate payload (filePath)
            alt Invalid payload
                Gateway-->>Client1: error<br/>{success: false, error: {message, code: "INVALID_PAYLOAD"}, timestamp}
            else Valid payload
                Gateway->>Service: findOne(uuid)
                Service->>Repo: findById(uuid)
                Repo->>DB: SELECT agent WHERE id
                DB-->>Repo: agent entity
                Repo-->>Service: agent entity
                Service-->>Gateway: agent details
                Gateway->>Gateway: Log: "Agent updated file /path/to/file.ts"
                Gateway->>Gateway: broadcastToAgent(uuid, 'fileUpdateNotification', {...})

                Note over Gateway: Broadcasts to all clients authenticated to this agent
                Gateway->>Gateway: Find all socket IDs for this agent
                Gateway->>Gateway: For each socket: socket.emit('fileUpdateNotification', {...})

                Gateway-->>Client1: fileUpdateNotification<br/>{success: true, data: {socketId: "socket-1", filePath: "/path/to/file.ts", timestamp}, timestamp}
                Gateway-->>Client2: fileUpdateNotification<br/>{success: true, data: {socketId: "socket-1", filePath: "/path/to/file.ts", timestamp}, timestamp}

                Note over Client1: Client 1 receives notification<br/>socketId matches own socket ID<br/>No action needed (update came from self)
                Note over Client2: Client 2 receives notification<br/>socketId doesn't match own socket ID<br/>If input is dirty: show modal<br/>User can Accept (reload) or Reject (keep dirty)
            end
        end
    end

    rect rgb(255, 240, 220)
        Note over Client1,DB: Error Handling
        alt Error during processing
            Gateway->>Gateway: Catch error
            Gateway-->>Client1: error<br/>{success: false, error: {message, code: "FILE_UPDATE_ERROR"}, timestamp}
            Gateway->>Gateway: Log error with stack trace
        end
    end
