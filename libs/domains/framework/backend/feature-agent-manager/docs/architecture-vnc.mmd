flowchart TB
    subgraph AgentManager["Agent Manager Service"]
        direction TB
        AgentsService["AgentsService"]
        DockerService["DockerService"]
        AgentsRepo["AgentsRepository"]
        DB[(PostgreSQL Database)]
    end

    subgraph DockerHost["Docker Host"]
        direction TB

        subgraph AgentContainer["Agent Container"]
            direction TB
            AgentProcess["Cursor Agent Process"]
            WorkspaceVolume["/app<br/>(Workspace Volume)"]
        end

        subgraph VNCContainer["VNC Container"]
            direction TB
            TigerVNC["TigerVNC Server<br/>:1 (Port 5901)"]
            WebSockify["websockify<br/>Port 6080"]
            XFCE4["XFCE4 Desktop"]
            Chromium["Chromium Browser<br/>(Auto-started)"]
            VNCWorkspace["/app<br/>(Shared Workspace)"]
        end

        DockerNetwork["Docker Network<br/>(Isolated Network)"]
    end

    subgraph Client["Client Browser"]
        direction TB
        NoVNC["noVNC Client<br/>(HTTPS)"]
    end

    AgentsService -->|"1. Create Agent"| DockerService
    DockerService -->|"2. Create Container"| AgentContainer
    DockerService -->|"3. Create VNC Container"| VNCContainer
    DockerService -->|"4. Create Network"| DockerNetwork
    DockerService -->|"5. Connect Containers"| DockerNetwork

    AgentsService -->|"6. Store VNC Info"| AgentsRepo
    AgentsRepo -->|"7. Persist"| DB

    AgentContainer -.->|"Shared Volume"| WorkspaceVolume
    VNCContainer -.->|"Shared Volume"| VNCWorkspace
    WorkspaceVolume -.->|"Same Volume"| VNCWorkspace

    AgentContainer -->|"Network Communication"| DockerNetwork
    VNCContainer -->|"Network Communication"| DockerNetwork

    XFCE4 -->|"Starts"| Chromium
    TigerVNC -->|"VNC Protocol"| WebSockify
    WebSockify -->|"WebSocket/HTTPS"| NoVNC
    Client -->|"HTTPS Request"| NoVNC

    style AgentManager fill:#e6f0ff,stroke:#4a90e2,stroke-width:3px
    style DockerHost fill:#e6ffe6,stroke:#4a9e2,stroke-width:3px
    style Client fill:#fff4e6,stroke:#ff8c42,stroke-width:3px
    style AgentContainer fill:#f0f7ff,stroke:#4a90e2
    style VNCContainer fill:#f0fff0,stroke:#4a9e2
    style DockerNetwork fill:#ffe6cc,stroke:#ff8c42
    style DB fill:#f5f5f5,stroke:#666
