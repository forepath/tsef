openapi: 3.1.0
info:
  title: Agent Manager API
  version: 1.0.0
  description: HTTP API for managing agents
  contact:
    name: ForePath
    email: hi@forepath.io
    url: https://forepath.io
servers:
  - url: http://localhost:3000/api
    description: Local development
security:
  - bearerAuth: []
paths:
  /agents:
    get:
      summary: List agents
      operationId: listAgents
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 0
          description: Maximum number of agents to return (default 10)
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
          description: Number of agents to skip (default 0)
      responses:
        '200':
          description: Array of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AgentResponseDto'
    post:
      summary: Create agent
      operationId: createAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAgentDto'
      responses:
        '201':
          description: Created agent with generated password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAgentResponseDto'
  /agents/{id}:
    get:
      summary: Get agent by id
      operationId: getAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponseDto'
    post:
      summary: Update agent
      operationId: updateAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAgentDto'
      responses:
        '200':
          description: Updated agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponseDto'
    delete:
      summary: Delete agent
      operationId: deleteAgent
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted
  /config:
    get:
      summary: Get configuration parameters
      operationId: getConfig
      responses:
        '200':
          description: Configuration parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponseDto'
  /agents/{agentId}/files:
    get:
      summary: List directory contents
      operationId: listDirectory
      parameters:
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: path
          schema:
            type: string
          description: Directory path relative to /app (defaults to '.')
      responses:
        '200':
          description: Array of file nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FileNodeDto'
        '404':
          description: Agent or directory not found
  /agents/{agentId}/files/{path}:
    get:
      summary: Read file content
      operationId: readFile
      parameters:
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File path relative to /app (supports nested paths)
      responses:
        '200':
          description: File content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileContentDto'
        '400':
          description: Invalid path
        '404':
          description: Agent or file not found
    post:
      summary: Create file or directory
      operationId: createFileOrDirectory
      parameters:
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFileDto'
      responses:
        '201':
          description: File or directory created
        '400':
          description: Invalid request
        '404':
          description: Agent not found
    put:
      summary: Write file content
      operationId: writeFile
      parameters:
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File path relative to /app (supports nested paths)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WriteFileDto'
      responses:
        '204':
          description: File written successfully
        '400':
          description: Invalid path or content too large
        '404':
          description: Agent not found
    delete:
      summary: Delete file or directory
      operationId: deleteFileOrDirectory
      parameters:
        - in: path
          name: agentId
          required: true
          schema:
            type: string
            format: uuid
        - in: path
          name: path
          required: true
          schema:
            type: string
          description: File or directory path relative to /app (supports nested paths)
      responses:
        '204':
          description: File or directory deleted successfully
        '400':
          description: Invalid path
        '404':
          description: Agent or file/directory not found
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    CreateAgentDto:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: [string, 'null']
    UpdateAgentDto:
      type: object
      properties:
        name:
          type: [string, 'null']
        description:
          type: [string, 'null']
    AgentResponseDto:
      type: object
      required: [id, name, createdAt, updatedAt]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: [string, 'null']
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    CreateAgentResponseDto:
      allOf:
        - $ref: '#/components/schemas/AgentResponseDto'
        - type: object
          required: [password]
          properties:
            password:
              type: string
    ConfigResponseDto:
      type: object
      properties:
        gitRepositoryUrl:
          type: [string, 'null']
          description: Git repository URL used for cloning repositories when creating agents
    FileContentDto:
      type: object
      required: [content, encoding]
      properties:
        content:
          type: string
          description: File content as base64-encoded string (supports both text and binary files)
        encoding:
          type: string
          enum: [utf-8, base64]
          description: Encoding indicator - 'utf-8' for text files, 'base64' for binary files
    FileNodeDto:
      type: object
      required: [name, type, path]
      properties:
        name:
          type: string
          description: File or directory name
        type:
          type: string
          enum: [file, directory]
          description: Node type
        path:
          type: string
          description: Relative path from /app
        size:
          type: [integer, 'null']
          description: File size in bytes (only for files)
        modifiedAt:
          type: [string, 'null']
          format: date-time
          description: Last modification timestamp
    WriteFileDto:
      type: object
      required: [content]
      properties:
        content:
          type: string
          description: File content as base64-encoded string (supports both text and binary files)
        encoding:
          type: string
          enum: [utf-8, base64]
          description: Optional encoding indicator - 'utf-8' for text files, 'base64' for binary files (defaults to 'utf-8')
    CreateFileDto:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [file, directory]
          description: Type of node to create
        content:
          type: [string, 'null']
          description: Optional content for file creation
