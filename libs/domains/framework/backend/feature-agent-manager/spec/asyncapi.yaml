asyncapi: 3.0.0
info:
  title: Agent Gateway
  version: 1.0.0
  description: WebSocket events for the agents chat gateway (Socket.IO namespace "agents")
servers:
  local:
    host: localhost:8080
    protocol: ws
    description: Socket.IO server (namespace /agents)
channels:
  agents/login:
    address: agents/login
    messages:
      loginCommand:
        $ref: '#/components/messages/Login'
    description: Client sends login command with credentials (agentId or name + password)
  agents/loginSuccess:
    address: agents/loginSuccess
    messages:
      loginSuccessEvent:
        $ref: '#/components/messages/LoginSuccess'
    description: Server acknowledges successful login. After this event, chat history is automatically restored via chatMessage events.
  agents/loginError:
    address: agents/loginError
    messages:
      loginErrorEvent:
        $ref: '#/components/messages/LoginError'
    description: Server returns login failure reason
  agents/chat:
    address: agents/chat
    messages:
      chatCommand:
        $ref: '#/components/messages/Chat'
    description: Client sends a chat message (requires prior login)
  agents/chatMessage:
    address: agents/chatMessage
    messages:
      chatBroadcast:
        $ref: '#/components/messages/ChatMessage'
    description: Server broadcasts chat messages to all connected clients. Also used for chat history restoration after successful login (messages are emitted in chronological order to the authenticated client only).
  agents/error:
    address: agents/error
    messages:
      errorEvent:
        $ref: '#/components/messages/Error'
    description: Generic error messages for unauthorized or processing failures
  agents/fileUpdate:
    address: agents/fileUpdate
    messages:
      fileUpdateCommand:
        $ref: '#/components/messages/FileUpdate'
    description: Client sends file update notification (requires prior login). Broadcasts to all clients authenticated to the same agent.
  agents/fileUpdateNotification:
    address: agents/fileUpdateNotification
    messages:
      fileUpdateNotificationEvent:
        $ref: '#/components/messages/FileUpdateNotification'
    description: Server broadcasts file update notifications to all clients authenticated to the same agent. Includes socket ID to identify the source of the update.
  agents/logout:
    address: agents/logout
    messages:
      logoutCommand:
        $ref: '#/components/messages/Logout'
    description: Client sends logout command to end authenticated session
  agents/logoutSuccess:
    address: agents/logoutSuccess
    messages:
      logoutSuccessEvent:
        $ref: '#/components/messages/LogoutSuccess'
    description: Server acknowledges successful logout
  agents/createTerminal:
    address: agents/createTerminal
    messages:
      createTerminalCommand:
        $ref: '#/components/messages/CreateTerminal'
    description: Client sends create terminal command (requires prior login). Creates a new TTY session for the agent's container.
  agents/terminalCreated:
    address: agents/terminalCreated
    messages:
      terminalCreatedEvent:
        $ref: '#/components/messages/TerminalCreated'
    description: Server acknowledges successful terminal creation. Terminal session is client-specific (socket.id based).
  agents/terminalInput:
    address: agents/terminalInput
    messages:
      terminalInputCommand:
        $ref: '#/components/messages/TerminalInput'
    description: Client sends input data to a terminal session (requires prior login). Only the socket that created the session can send input.
  agents/terminalOutput:
    address: agents/terminalOutput
    messages:
      terminalOutputEvent:
        $ref: '#/components/messages/TerminalOutput'
    description: Server sends terminal output data to the client. Emitted whenever the terminal session produces output.
  agents/closeTerminal:
    address: agents/closeTerminal
    messages:
      closeTerminalCommand:
        $ref: '#/components/messages/CloseTerminal'
    description: Client sends close terminal command (requires prior login). Only the socket that created the session can close it.
  agents/terminalClosed:
    address: agents/terminalClosed
    messages:
      terminalClosedEvent:
        $ref: '#/components/messages/TerminalClosed'
    description: Server acknowledges terminal closure. Also emitted when terminal session ends (e.g., exit command).
  agents/containerStats:
    address: agents/containerStats
    messages:
      containerStatsEvent:
        $ref: '#/components/messages/ContainerStats'
    description: Server broadcasts container statistics (CPU, memory, network, etc.) periodically to all clients authenticated to the agent. First stats are sent immediately after successful login, then every 5 seconds while clients remain authenticated.
operations:
  clientSendsLogin:
    action: send
    channel:
      $ref: '#/channels/agents~1login'
    messages:
      - $ref: '#/channels/agents~1login/messages/loginCommand'
  serverEmitsLoginSuccess:
    action: receive
    channel:
      $ref: '#/channels/agents~1loginSuccess'
    messages:
      - $ref: '#/channels/agents~1loginSuccess/messages/loginSuccessEvent'
  serverEmitsLoginError:
    action: receive
    channel:
      $ref: '#/channels/agents~1loginError'
    messages:
      - $ref: '#/channels/agents~1loginError/messages/loginErrorEvent'
  clientSendsChat:
    action: send
    channel:
      $ref: '#/channels/agents~1chat'
    messages:
      - $ref: '#/channels/agents~1chat/messages/chatCommand'
  serverBroadcastsChatMessage:
    action: receive
    channel:
      $ref: '#/channels/agents~1chatMessage'
    messages:
      - $ref: '#/channels/agents~1chatMessage/messages/chatBroadcast'
  serverEmitsError:
    action: receive
    channel:
      $ref: '#/channels/agents~1error'
    messages:
      - $ref: '#/channels/agents~1error/messages/errorEvent'
  clientSendsFileUpdate:
    action: send
    channel:
      $ref: '#/channels/agents~1fileUpdate'
    messages:
      - $ref: '#/channels/agents~1fileUpdate/messages/fileUpdateCommand'
  serverBroadcastsFileUpdateNotification:
    action: receive
    channel:
      $ref: '#/channels/agents~1fileUpdateNotification'
    messages:
      - $ref: '#/channels/agents~1fileUpdateNotification/messages/fileUpdateNotificationEvent'
  clientSendsLogout:
    action: send
    channel:
      $ref: '#/channels/agents~1logout'
    messages:
      - $ref: '#/channels/agents~1logout/messages/logoutCommand'
  serverEmitsLogoutSuccess:
    action: receive
    channel:
      $ref: '#/channels/agents~1logoutSuccess'
    messages:
      - $ref: '#/channels/agents~1logoutSuccess/messages/logoutSuccessEvent'
  clientSendsCreateTerminal:
    action: send
    channel:
      $ref: '#/channels/agents~1createTerminal'
    messages:
      - $ref: '#/channels/agents~1createTerminal/messages/createTerminalCommand'
  serverEmitsTerminalCreated:
    action: receive
    channel:
      $ref: '#/channels/agents~1terminalCreated'
    messages:
      - $ref: '#/channels/agents~1terminalCreated/messages/terminalCreatedEvent'
  clientSendsTerminalInput:
    action: send
    channel:
      $ref: '#/channels/agents~1terminalInput'
    messages:
      - $ref: '#/channels/agents~1terminalInput/messages/terminalInputCommand'
  serverEmitsTerminalOutput:
    action: receive
    channel:
      $ref: '#/channels/agents~1terminalOutput'
    messages:
      - $ref: '#/channels/agents~1terminalOutput/messages/terminalOutputEvent'
  clientSendsCloseTerminal:
    action: send
    channel:
      $ref: '#/channels/agents~1closeTerminal'
    messages:
      - $ref: '#/channels/agents~1closeTerminal/messages/closeTerminalCommand'
  serverEmitsTerminalClosed:
    action: receive
    channel:
      $ref: '#/channels/agents~1terminalClosed'
    messages:
      - $ref: '#/channels/agents~1terminalClosed/messages/terminalClosedEvent'
  serverBroadcastsContainerStats:
    action: receive
    channel:
      $ref: '#/channels/agents~1containerStats'
    messages:
      - $ref: '#/channels/agents~1containerStats/messages/containerStatsEvent'
components:
  securitySchemes:
    jwt:
      type: httpApiKey
      name: Authorization
      in: header
      description: 'Bearer JWT from Keycloak, e.g. Authorization: Bearer <token>'
  messages:
    Login:
      name: Login
      title: Login command
      contentType: application/json
      payload:
        type: object
        required: [agentId, password]
        properties:
          agentId:
            type: string
            description: Agent UUID or name
          password:
            type: string
    LoginSuccess:
      name: LoginSuccess
      title: Login success event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [message, agentId, agentName]
            properties:
              message:
                type: string
                description: Welcome message
              agentId:
                type: string
                description: Agent UUID
              agentName:
                type: string
                description: Agent name
          timestamp:
            type: string
            description: ISO timestamp
    LoginError:
      name: LoginError
      title: Login error event
      contentType: application/json
      payload:
        type: object
        required: [success, error, timestamp]
        properties:
          success:
            type: boolean
            enum: [false]
          error:
            type: object
            required: [message]
            properties:
              message:
                type: string
                description: Error message
              code:
                type: string
                description: Error code (optional)
                enum: [INVALID_CREDENTIALS, LOGIN_ERROR]
              details:
                type: string
                description: Additional error details (optional)
          timestamp:
            type: string
            description: ISO timestamp
    Chat:
      name: Chat
      title: Chat command
      contentType: application/json
      payload:
        type: object
        required: [message]
        properties:
          message:
            type: string
            description: Message text
          model:
            type: string
            description: Optional model identifier (e.g., gpt-4o) forwarded to the agent container to override the default model for this chat request
    ChatMessage:
      name: ChatMessage
      title: Chat broadcast event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            oneOf:
              - type: object
                required: [from, text, timestamp]
                properties:
                  from:
                    type: string
                    enum: [user]
                  text:
                    type: string
                    description: Message text
                  timestamp:
                    type: string
                    description: ISO timestamp
              - type: object
                required: [from, response, timestamp]
                properties:
                  from:
                    type: string
                    enum: [agent]
                  response:
                    oneOf:
                      - type: object
                        properties:
                          type:
                            type: string
                          subtype:
                            type: string
                          is_error:
                            type: boolean
                          duration_ms:
                            type: number
                          duration_api_ms:
                            type: number
                          result:
                            type: string
                          session_id:
                            type: string
                          request_id:
                            type: string
                        description: Parsed JSON response object from agent
                      - type: string
                        description: Cleaned string response if JSON parsing fails (text before first { and after last } is removed)
                  timestamp:
                    type: string
                    description: ISO timestamp
          timestamp:
            type: string
            description: ISO timestamp
    Error:
      name: Error
      title: Error event
      contentType: application/json
      payload:
        type: object
        required: [success, error, timestamp]
        properties:
          success:
            type: boolean
            enum: [false]
          error:
            type: object
            required: [message]
            properties:
              message:
                type: string
                description: Error message
              code:
                type: string
                description: Error code (optional)
                enum:
                  [
                    UNAUTHORIZED,
                    CHAT_ERROR,
                    INVALID_PAYLOAD,
                    FILE_UPDATE_ERROR,
                    TERMINAL_ERROR,
                  ]
              details:
                type: string
                description: Additional error details (optional)
          timestamp:
            type: string
            description: ISO timestamp
    FileUpdate:
      name: FileUpdate
      title: File update command
      contentType: application/json
      payload:
        type: object
        required: [filePath]
        properties:
          filePath:
            type: string
            description: Path to the file that was updated
    FileUpdateNotification:
      name: FileUpdateNotification
      title: File update notification event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [socketId, filePath, timestamp]
            properties:
              socketId:
                type: string
                description: Socket ID of the client who made the update. Clients can compare this with their own socket ID to determine if the update came from themselves or another client.
              filePath:
                type: string
                description: Path to the file that was updated
              timestamp:
                type: string
                description: ISO timestamp of the update
          timestamp:
            type: string
            description: ISO timestamp
    Logout:
      name: Logout
      title: Logout command
      contentType: application/json
      payload:
        type: object
        description: Empty payload - no parameters required
    LogoutSuccess:
      name: LogoutSuccess
      title: Logout success event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [message, agentId, agentName]
            properties:
              message:
                type: string
                description: Success message
              agentId:
                type: string
                nullable: true
                description: Agent UUID (null if not authenticated)
              agentName:
                type: string
                nullable: true
                description: Agent name (null if not authenticated)
          timestamp:
            type: string
            description: ISO timestamp
    CreateTerminal:
      name: CreateTerminal
      title: Create terminal command
      contentType: application/json
      payload:
        type: object
        properties:
          sessionId:
            type: string
            description: Optional session ID (will be generated if not provided)
          shell:
            type: string
            description: Optional shell command (defaults to 'sh')
    TerminalCreated:
      name: TerminalCreated
      title: Terminal created event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [sessionId]
            properties:
              sessionId:
                type: string
                description: Terminal session ID (client-specific, socket.id based)
          timestamp:
            type: string
            description: ISO timestamp
    TerminalInput:
      name: TerminalInput
      title: Terminal input command
      contentType: application/json
      payload:
        type: object
        required: [sessionId, data]
        properties:
          sessionId:
            type: string
            description: Terminal session ID
          data:
            type: string
            description: Input data to send to terminal
    TerminalOutput:
      name: TerminalOutput
      title: Terminal output event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [sessionId, data]
            properties:
              sessionId:
                type: string
                description: Terminal session ID
              data:
                type: string
                description: Terminal output data
          timestamp:
            type: string
            description: ISO timestamp
    CloseTerminal:
      name: CloseTerminal
      title: Close terminal command
      contentType: application/json
      payload:
        type: object
        required: [sessionId]
        properties:
          sessionId:
            type: string
            description: Terminal session ID to close
    TerminalClosed:
      name: TerminalClosed
      title: Terminal closed event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [sessionId]
            properties:
              sessionId:
                type: string
                description: Terminal session ID that was closed
          timestamp:
            type: string
            description: ISO timestamp
    ContainerStats:
      name: ContainerStats
      title: Container stats event
      contentType: application/json
      payload:
        type: object
        required: [success, data, timestamp]
        properties:
          success:
            type: boolean
            enum: [true]
          data:
            type: object
            required: [stats, timestamp]
            properties:
              stats:
                type: object
                description: Docker container statistics object (CPU, memory, network, etc.). See Docker API documentation for full structure.
                properties:
                  read:
                    type: string
                    description: Timestamp when stats were read
                  preread:
                    type: string
                    description: Previous read timestamp
                  pids_stats:
                    type: object
                    description: Process ID statistics
                  blkio_stats:
                    type: object
                    description: Block I/O statistics
                  num_procs:
                    type: number
                    description: Number of processes
                  storage_stats:
                    type: object
                    description: Storage statistics
                  cpu_stats:
                    type: object
                    description: CPU usage statistics
                  precpu_stats:
                    type: object
                    description: Previous CPU statistics
                  memory_stats:
                    type: object
                    description: Memory usage statistics
                  networks:
                    type: object
                    description: Network statistics
              timestamp:
                type: string
                description: ISO timestamp when stats were collected
          timestamp:
            type: string
            description: ISO timestamp
