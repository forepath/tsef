<div class="file-tree-container d-flex flex-column h-100">
  <div class="file-tree-header p-2 border-bottom bg-body-tertiary">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0 fw-semibold">Files</h6>
      <div class="btn-group btn-group-sm" role="group">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          [class.active]="creatingItem()?.path === '.' && creatingItem()?.type === 'file'"
          (click)="onCreateItem('file')"
          title="New File"
        >
          <i class="bi bi-file-earmark-plus"></i>
        </button>
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          [class.active]="creatingItem()?.path === '.' && creatingItem()?.type === 'directory'"
          (click)="onCreateItem('directory')"
          title="New Directory"
        >
          <i class="bi bi-folder-plus"></i>
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="onUploadFile()" title="Upload File">
          <i class="bi bi-upload"></i>
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="onRefreshRoot()" title="Refresh">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>
  </div>

  <div
    class="file-tree-content flex-grow-1 overflow-auto p-2"
    [class.drag-over-root]="dragOverPath() === '.'"
    (dragover)="onDragOverRoot($event)"
    (dragenter)="onDragEnterRoot($event)"
    (dragleave)="onDragLeaveRoot($event)"
    (drop)="onDropRoot($event)"
  >
    @if (rootLoading$ | async) {
      <div class="d-flex justify-content-center align-items-center p-4">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    } @else {
      @if (treeNodes().length === 0) {
        <div class="text-center text-muted p-4">
          <i class="bi bi-folder-x fs-4 d-block mb-2"></i>
          <p class="mb-0 small">No files</p>
        </div>
        <!-- Show create input at root level if creating at root and tree is empty -->
        @if (creatingItem()?.path === '.') {
          <div class="create-item-input px-2 py-1" [style.padding-left.px]="24">
            <div class="input-group input-group-sm">
              <input
                type="text"
                class="form-control form-control-sm"
                [(ngModel)]="newItemName"
                (keydown.enter)="onConfirmCreate()"
                (keydown.escape)="onCancelCreate()"
                [placeholder]="creatingItem()?.type === 'file' ? 'Enter file name...' : 'Enter folder name...'"
                autofocus
              />
              <button class="btn btn-sm btn-primary" type="button" (click)="onConfirmCreate()">
                <i class="bi bi-check"></i>
              </button>
              <button class="btn btn-sm btn-secondary" type="button" (click)="onCancelCreate()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        }
      } @else {
        <ul class="file-tree list-unstyled mb-0">
          <!-- Show create input at root level if creating at root -->
          @if (creatingItem()?.path === '.') {
            <li>
              <div class="create-item-input px-2 py-1" [style.padding-left.px]="24">
                <div class="input-group input-group-sm">
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    [(ngModel)]="newItemName"
                    (keydown.enter)="onConfirmCreate()"
                    (keydown.escape)="onCancelCreate()"
                    [placeholder]="creatingItem()?.type === 'file' ? 'Enter file name...' : 'Enter folder name...'"
                    autofocus
                  />
                  <button class="btn btn-sm btn-primary" type="button" (click)="onConfirmCreate()">
                    <i class="bi bi-check"></i>
                  </button>
                  <button class="btn btn-sm btn-secondary" type="button" (click)="onCancelCreate()">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>
            </li>
          }
          @for (node of treeNodes(); track node.path; let isLast = $last; let idx = $index) {
            <li>
              <ng-container
                [ngTemplateOutlet]="treeNodeTemplate"
                [ngTemplateOutletContext]="{
                  $implicit: node,
                  level: 0,
                  isLast: isLast,
                  hasSiblings: treeNodes().length > 1,
                  parentChildren: treeNodes(),
                }"
              ></ng-container>
            </li>
          }
        </ul>
      }
    }
  </div>

  @if (clientRepositoryName$ | async; as repoName) {
    <div class="file-tree-repo px-2 py-1 border-top bg-body-tertiary">
      <div class="d-flex align-items-center gap-2">
        <small class="text-muted d-flex align-items-center gap-2 text-truncate flex-grow-1" [title]="repoName">
          <i class="bi bi-git me-1"></i>
          <span class="text-truncate">{{ repoName }}</span>
        </small>
        @if (currentBranch$ | async; as branch) {
          <div class="d-flex align-items-center gap-2">
            <small
              class="text-muted d-flex align-items-center gap-2 cursor-pointer"
              (click)="onOpenBranchModal()"
              [title]="'Current branch: ' + branch"
            >
              <i class="bi bi-diagram-3"></i>
              <span class="text-truncate">{{ branch }}</span>
            </small>
            @if (statusIndicator$ | async; as indicator) {
              <span
                class="git-status-indicator rounded-circle cursor-pointer position-relative d-inline-flex align-items-center justify-content-center"
                [class.status-clean]="indicator === 'clean'"
                [class.status-changes]="indicator === 'changes'"
                [class.status-conflict]="indicator === 'conflict'"
                [class.has-spinner]="showStatusIndicatorSpinner$ | async"
                (click)="onStatusIndicatorClick($event)"
                [title]="
                  indicator === 'clean'
                    ? 'In sync with remote - Click to open Version Control'
                    : indicator === 'changes'
                      ? 'Local changes (staged, unstaged, or unpushed) - Click to open Version Control'
                      : 'Merge conflicts detected - Click to open Version Control'
                "
              >
                @if (showStatusIndicatorSpinner$ | async) {
                  <span
                    class="spinner-border spinner-border-sm"
                    role="status"
                    style="width: 10px; height: 10px; border-width: 1.5px"
                  >
                    <span class="visually-hidden">Loading...</span>
                  </span>
                }
              </span>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Git Branch Modal -->
  <framework-git-branch-modal
    [clientId]="clientId()"
    [agentId]="agentId()"
    [isOpen]="branchModalOpen()"
    (closed)="onBranchModalClosed()"
  ></framework-git-branch-modal>

  <!-- Hidden file inputs for upload -->
  <input #rootFileInput type="file" class="d-none" (change)="onFileSelected($event)" multiple />
  <input #folderFileInput type="file" class="d-none" (change)="onFileSelected($event)" multiple />
</div>

<!-- Tree Node Template -->
<ng-template
  #treeNodeTemplate
  let-node
  let-level="level"
  let-isLast="isLast"
  let-hasSiblings="hasSiblings"
  let-parentChildren="parentChildren"
>
  <div class="tree-node-wrapper">
    <div
      class="tree-node d-flex align-items-center py-1 px-2 rounded"
      [class.selected]="selectedPath() === node.path"
      [class.expanded]="node.expanded"
      [class.has-children]="node.children && node.children.length > 0"
      [class.creating-in]="creatingItem()?.path === node.path"
      [class.dragging]="draggedItem()?.path === node.path"
      [class.drag-over]="dragOverPath() === node.path && node.type === 'directory'"
      [draggable]="true"
      (click)="onFileClick(node, $event)"
      (contextmenu)="onContextMenu($event, node)"
      (dragstart)="onDragStart($event, node)"
      (dragend)="onDragEnd()"
      (dragover)="onDragOver($event, node)"
      (dragenter)="onDragEnter($event, node)"
      (dragleave)="onDragLeave($event, node)"
      (drop)="onDrop($event, node)"
    >
      <!-- Tree indentation with visual guides -->
      @if (level > 0) {
        <div class="tree-indent" [style.width.px]="level * 20">
          @for (i of getLevelArray(level); track i; let idx = $index) {
            <div class="tree-indent-line" [class.line-visible]="hasSiblings || idx < level - 1"></div>
          }
        </div>
      }

      <!-- Node content -->
      <div class="tree-node-content d-flex align-items-center flex-grow-1">
        @if (node.type === 'directory') {
          <i
            class="bi me-2 tree-node-icon"
            [class.bi-chevron-right]="!node.expanded"
            [class.bi-chevron-down]="node.expanded"
            [class.bi-folder]="!node.expanded"
            [class.bi-folder2-open]="node.expanded"
          ></i>
        } @else {
          <i class="bi me-2 tree-node-icon" [ngClass]="getIcon(node)"></i>
        }
        <span class="tree-node-name flex-grow-1 text-truncate" [title]="node.name">{{ node.name }}</span>
        <div class="btn-group btn-group-sm ms-2" role="group">
          @if (node.type === 'directory') {
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary py-0 px-1"
              [class.active]="creatingItem()?.path === node.path && creatingItem()?.type === 'file'"
              (click)="onCreateItem('file', node.path); $event.stopPropagation()"
              title="New File"
            >
              <i class="bi bi-file-earmark-plus"></i>
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary py-0 px-1"
              [class.active]="creatingItem()?.path === node.path && creatingItem()?.type === 'directory'"
              (click)="onCreateItem('directory', node.path); $event.stopPropagation()"
              title="New Directory"
            >
              <i class="bi bi-folder-plus"></i>
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary py-0 px-1"
              (click)="onUploadFile(node.path); $event.stopPropagation()"
              title="Upload File"
            >
              <i class="bi bi-upload"></i>
            </button>
          }
          <button
            type="button"
            class="btn btn-sm btn-outline-danger py-0 px-1"
            (click)="onDeleteItem(node.path); $event.stopPropagation()"
            title="Delete"
          >
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Create Item Input (for nested nodes, root level is handled separately in the main template) -->
    @if (creatingItem()?.path === node.path && node.path !== '.') {
      <div class="create-item-input px-2 py-1" [style.padding-left.px]="(level + 1) * 20 + 24">
        <div class="input-group input-group-sm">
          <input
            type="text"
            class="form-control form-control-sm"
            [(ngModel)]="newItemName"
            (keydown.enter)="onConfirmCreate()"
            (keydown.escape)="onCancelCreate()"
            [placeholder]="creatingItem()?.type === 'file' ? 'Enter file name...' : 'Enter folder name...'"
            autofocus
          />
          <button class="btn btn-sm btn-primary" type="button" (click)="onConfirmCreate()">
            <i class="bi bi-check"></i>
          </button>
          <button class="btn btn-sm btn-secondary" type="button" (click)="onCancelCreate()">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>
    }

    <!-- Children -->
    @if (node.children && node.children.length > 0) {
      <ul class="list-unstyled mb-0 tree-children">
        @for (child of node.children; track child.path; let isLast = $last; let idx = $index) {
          <li>
            <ng-container
              [ngTemplateOutlet]="treeNodeTemplate"
              [ngTemplateOutletContext]="{
                $implicit: child,
                level: level + 1,
                isLast: isLast,
                hasSiblings: node.children.length > 1,
                parentChildren: node.children,
              }"
            ></ng-container>
          </li>
        }
      </ul>
    }
  </div>
</ng-template>

<!-- Context Menu -->
@if (contextMenuPath() && contextMenuPosition()) {
  <div
    class="context-menu dropdown-menu show"
    [style.position]="'fixed'"
    [style.left.px]="contextMenuPosition()!.x"
    [style.top.px]="contextMenuPosition()!.y"
    (click)="$event.stopPropagation()"
  >
    <button class="dropdown-item" (click)="onCreateItem('file', contextMenuPath() || undefined); onCloseContextMenu()">
      <i class="bi bi-file-earmark-plus me-2"></i>New File
    </button>
    <button
      class="dropdown-item"
      (click)="onCreateItem('directory', contextMenuPath() || undefined); onCloseContextMenu()"
    >
      <i class="bi bi-folder-plus me-2"></i>New Directory
    </button>
    @if (contextMenuPath() && (contextMenuPath() === '.' || findNodeByPath(contextMenuPath()!)?.type === 'directory')) {
      <button class="dropdown-item" (click)="onUploadFile(contextMenuPath()!); onCloseContextMenu()">
        <i class="bi bi-upload me-2"></i>Upload File
      </button>
    }
    @if (contextMenuPath() && findNodeByPath(contextMenuPath()!)?.type === 'directory') {
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" (click)="onRefreshFolder(contextMenuPath()!); onCloseContextMenu()">
        <i class="bi bi-arrow-clockwise me-2"></i>Refresh
      </button>
    }
    @if (contextMenuPath() && findNodeByPath(contextMenuPath()!)?.type === 'file') {
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" (click)="onCopyFileLink(contextMenuPath()!)">
        <i class="bi bi-link-45deg me-2"></i>Copy link
      </button>
      <button class="dropdown-item" (click)="onOpenInNewWindow(contextMenuPath()!)">
        <i class="bi bi-box-arrow-up-right me-2"></i>Open in a new window
      </button>
    }
    <div class="dropdown-divider"></div>
    <button class="dropdown-item" (click)="onRenameItem(contextMenuPath()!)">
      <i class="bi bi-pencil me-2"></i>Rename
    </button>
    <button class="dropdown-item" (click)="onMoveItem(contextMenuPath()!)">
      <i class="bi bi-arrow-right-circle me-2"></i>Move
    </button>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item text-danger" (click)="onDeleteItem(contextMenuPath()!)">
      <i class="bi bi-trash me-2"></i>Delete
    </button>
  </div>
}

<!-- Click outside to close context menu -->
@if (contextMenuPath()) {
  <div class="context-menu-overlay" (click)="onCloseContextMenu()"></div>
}

<!-- Delete File/Directory Confirmation Modal -->
<div
  class="modal fade"
  id="deleteFileModal"
  tabindex="-1"
  aria-labelledby="deleteFileModalLabel"
  aria-hidden="true"
  #deleteFileModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteFileModalLabel">
          Delete {{ itemToDelete()?.type === 'directory' ? 'Directory' : 'File' }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="itemToDelete.set(null)"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete the {{ itemToDelete()?.type === 'directory' ? 'directory' : 'file' }}
          <strong>{{ itemToDelete()?.path }}</strong
          >?
        </p>
        <p class="text-danger mb-0">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          This action cannot be undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="itemToDelete.set(null)">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDeleteItem()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Rename File/Directory Modal -->
<div
  class="modal fade"
  id="renameFileModal"
  tabindex="-1"
  aria-labelledby="renameFileModalLabel"
  aria-hidden="true"
  #renameFileModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="renameFileModalLabel">
          Rename {{ itemToRename()?.type === 'directory' ? 'Directory' : 'File' }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="cancelRenameItem()"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Enter a new name for the {{ itemToRename()?.type === 'directory' ? 'directory' : 'file' }}
          <strong>{{ itemToRename()?.path }}</strong
          >:
        </p>
        <div class="mb-3">
          <label for="renameNewName" class="form-label">New Name</label>
          <input
            type="text"
            class="form-control"
            id="renameNewName"
            [(ngModel)]="renameNewName"
            (keydown.enter)="confirmRenameItem()"
            (keydown.escape)="cancelRenameItem()"
            autofocus
          />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cancelRenameItem()">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="confirmRenameItem()"
          [disabled]="!renameNewName().trim() || renameNewName().trim() === itemToRename()?.name"
        >
          Rename
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Move File/Directory Modal -->
<div
  class="modal fade"
  id="moveFileModal"
  tabindex="-1"
  aria-labelledby="moveFileModalLabel"
  aria-hidden="true"
  #moveFileModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="moveFileModalLabel">
          Move {{ itemToMove()?.type === 'directory' ? 'Directory' : 'File' }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="cancelMoveItem()"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Move the {{ itemToMove()?.type === 'directory' ? 'directory' : 'file' }}
          <strong>{{ itemToMove()?.path }}</strong> to:
        </p>
        <div class="mb-3">
          <label for="moveDestinationPath" class="form-label">Destination Path</label>
          <input
            type="text"
            class="form-control"
            id="moveDestinationPath"
            [(ngModel)]="moveDestinationPath"
            (keydown.enter)="confirmMoveItem()"
            (keydown.escape)="cancelMoveItem()"
            placeholder="Enter destination path (e.g., 'folder' or 'folder/subfolder')"
            autofocus
          />
          <div class="form-text">
            Use '.' for root directory, or enter a relative path like 'folder' or 'folder/subfolder'
          </div>
        </div>
        <p class="text-muted small mb-0">
          <i class="bi bi-info-circle me-1"></i>
          The {{ itemToMove()?.type === 'directory' ? 'directory' : 'file' }} will be moved to:
          <strong>{{
            moveDestinationPath() === '.' ? itemToMove()?.name : moveDestinationPath() + '/' + itemToMove()?.name
          }}</strong>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cancelMoveItem()">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="confirmMoveItem()"
          [disabled]="!moveDestinationPath().trim()"
        >
          Move
        </button>
      </div>
    </div>
  </div>
</div>
