---
alwaysApply: true
---

# Context Management Guidelines

This document defines the rules and best practices for how Cursor AI MUST collect, compress, summarize, cite, and maintain context while working in this repository. It ensures consistent, reproducible behavior under token constraints and improves decision quality.

> The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119.

## Purpose and Scope

- These rules apply to all agent activities described in [framework_agents.mdc](./framework_agents.mdc) and govern context handling for analysis, implementation, validation, and documentation tasks.
- When context overflows token limits, agents MUST follow the prioritization, compression, and citation rules herein.

## Core Principles

- **Decision-critical first**: Agents **MUST** preserve information required to make correct changes or decisions.
- **Minimalism**: Agents **MUST** include only the smallest amount of context necessary to act.
- **Traceability**: All summarizations **MUST** retain links or file/line citations back to sources.
- **Determinism**: Agents **MUST** follow the same ordering and format so results are predictable.
- **Safety**: Agents **MUST** remove secrets and redact sensitive values, and **SHOULD** prefer references over raw content.

## Context Priority Order (when overflow occurs)

Agents **MUST** apply the following order when context exceeds token limits:

1. User's latest request and explicit acceptance criteria
2. Active workspace signal: open files, cursor locations, recent edits, staged diffs
3. Errors: linter diagnostics, build/test failures, stack traces (first occurrence per unique signature)
4. Code under change: smallest necessary slices of functions/classes/types and public APIs/contracts
5. Repository rules that materially affect the task (link or short quote), especially:
   - [framework_agents.mdc](./framework_agents.mdc)
   - [framework_applications.mdc](./framework_applications.mdc)
   - [framework_domains_and_libraries.mdc](./framework_domains_and_libraries.mdc)
   - [framework_conventional_commits.mdc](./framework_conventional_commits.mdc)
   - [framework_software_develoment_principals.mdc](./framework_software_develoment_principals.mdc)
6. Historical context strictly required to avoid rework (brief bullets with links/citations)

Agents **SHOULD** summarize or drop first the following items:
- Generated code, large assets, long boilerplate, unchanged code not referenced
- Redundant history superseded by newer instructions
- Repeated log lines beyond first-unique occurrence

## Summarization and Compression Rules

- Agents **MUST** use short bullets and **MUST** avoid narrative unless requested.
- Agents **MUST** normalize repeated paths/terms (e.g., alias long paths when unambiguous).
- Agents **SHOULD** extract API surfaces (signatures and types) instead of entire files where possible.
- For logs, agents **MUST** include the first occurrence per unique message/signature and **MUST** elide subsequent repetitions.
- Agents **MUST** use elisions (`…`) to indicate omitted middle sections when showing excerpts.

## Code and Log Citation Rules

- When citing existing code, agents **MUST** use code references with file path and line spans, not full-file pastes, following the repository's citation conventions.
- When proposing new code, agents **MUST** use standard fenced code blocks with language tags and **MUST NOT** include artificial line numbers.
- Agents **SHOULD** prefer linking to authoritative sources (files/sections) rather than duplicating lengthy content.

## Token Budgeting

- Agents **SHOULD** allocate ~60–70% of available tokens to “active task” materials (latest ask, open files, diffs, errors).
- Agents **SHOULD** allocate ~20–30% to essential rules/constraints from the repository ruleset.
- Agents **SHOULD** use the remaining budget for minimal historical context and alternatives.
- Summaries **SHOULD** target ≤ 350 tokens unless the user explicitly requests more.

## Conflict Resolution

- If rules and prior conversation conflict, repository rules **MUST** prevail. Agents **MUST** note the conflict briefly and proceed with rules.
- If a choice is required between including code or prose, agents **MUST** include the smallest code slice required for correctness, plus a one-line rationale.

## Operation Modes Integration

- In Plan-First Mode, summaries **SHOULD** emphasize requirements, constraints, affected projects, and a minimal plan with links to sources.
- In Immediate Implementation Mode, summaries **SHOULD** emphasize diffs/snippets, errors, and exact file paths to execute changes safely.

## Nx and Validation Alignment

- Context included for validation **MUST** prioritize Nx commands, affected projects, and diagnostics as per [framework_agents.mdc](./framework_agents.mdc).
- When summarizing validation outcomes, agents **SHOULD** include only failing target names, the first error per target, and a link/citation to full logs.

## Output Structure (when summarizing context)

Agents **MUST** use the following compact structure unless the user explicitly requests a different format:

1. What's changing (1–3 bullets)
2. Why it matters (1–2 bullets)
3. Key code references (file:line–line)
4. Errors/risks (first occurrence per unique error)
5. Rules in effect (short list of links)

## Privacy and Security

- Secrets and tokens **MUST NOT** be reproduced. Agents **MUST** redact values and point to secure storage or config files.
- Agents **SHOULD** remove PII unless explicitly required for debugging; otherwise, generalize.

## Examples (illustrative)

- Code reference (existing): include minimal lines around the change.
- Proposed code (new): fenced code blocks with language tag; no line numbers.

### Worked Example (Bad vs Good)

- Bad (too verbose, no priorities, full paste):
  - Long narrative of history, multiple full-file dumps, repeated logs, unclear next steps.

- Good (applies priorities, minimal, cited):
  1. What's changing: Update auth token refresh in `auth.service.ts`.
  2. Why it matters: Fixes intermittent 401s after idle resume.
  3. Key code references:
```12:16:apps/frontend/src/app/auth/auth.service.ts
private scheduleRefresh() {
  // ... minimal snippet ...
}
```
  4. Errors/risks: Failing test "refresh on visibilitychange"; race on rapid tab switch.
  5. Rules in effect: [framework_agents.mdc](./framework_agents.mdc), [framework_context_management.mdc](./framework_context_management.mdc)

## Compliance

- These rules are **REQUIRED** and complement [framework_agents.mdc](./framework_agents.mdc). If summarization would exceed limits, agents **MUST** apply this document's prioritization and compression before omitting any decision-critical content.
